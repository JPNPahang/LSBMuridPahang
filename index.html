<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Permohonan Lawatan JPN Pahang</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background:#f3f4f6; font-family: Inter, system-ui, sans-serif; }
  .tab-active { background-color:#1e40af; color:white; }
  .hidden { display:none !important; }
  .btn { padding:0.6rem 1rem; border-radius:0.5rem; }
  .card { background:white; border-radius:0.75rem; padding:1.25rem; box-shadow:0 6px 16px rgba(15,23,42,0.06); }
  .table-scroll { overflow:auto; max-height:520px; }
  .success-popup { position:fixed; right:20px; bottom:20px; background:#ecfccb; border:1px solid #86efac; padding:12px 16px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
  a.link-file { color:#1e40af; text-decoration:underline; }
  .small { font-size:0.85rem; color:#6b7280; }
</style>
</head>
<body>
<div class="container mx-auto max-w-6xl p-6">
  <header class="mb-6 card text-center">
    <h1 class="text-3xl font-bold text-blue-700">Sistem Permohonan Lawatan Sambil Belajar</h1>
    <p class="text-sm text-gray-600">Jabatan Pendidikan Negeri Pahang</p>
  </header>

  <nav class="flex gap-3 mb-6">
    <button id="tabBtnForm" class="flex-1 btn card tab-active">Borang Permohonan</button>
    <button id="tabBtnDashboard" class="flex-1 btn card">Dashboard JPN</button>
    <button id="tabBtnKelulusan" class="flex-1 btn card">Kelulusan Pengarah</button>
  </nav>

  <!-- FORM TAB -->
  <section id="tabForm" class="card">
    <div id="dbStatus" class="mb-4 p-3 bg-blue-50 text-blue-700 rounded">Memuatkan pangkalan data sekolah...</div>

    <div class="mb-4 flex gap-3">
      <button id="modeNew" class="bg-blue-600 text-white btn">Permohonan Baru</button>
      <button id="modeQuery" class="bg-gray-100 btn">Hantar Semula (Query)</button>
    </div>

    <div id="querySection" class="hidden card mb-4">
      <h3 class="font-semibold">Pembetulan Permohonan (Query)</h3>
      <div class="mt-2 flex gap-2">
        <input id="queryId" placeholder="ID Permohonan" class="border p-2 rounded flex-1" />
        <input id="queryEmail" placeholder="E-mel Berdaftar" class="border p-2 rounded flex-1" />
        <button id="btnQueryLookup" class="bg-blue-600 text-white btn">Cari</button>
      </div>
      <p id="queryError" class="text-red-600 hidden mt-2"></p>
    </div>

    <form id="mainForm" class="space-y-6">
      <input type="hidden" id="isQueryMode" value="false" />
      <input type="hidden" id="currentId" value="" />

      <!-- A -->
      <div>
        <h3 class="font-semibold">Bahagian A: Maklumat Sekolah</h3>
        <div class="grid grid-cols-1 sm:grid-cols-6 gap-3 mt-3">
          <div class="sm:col-span-2">
            <label>Kod Sekolah</label>
            <input id="kodSekolah" class="border p-2 rounded w-full" />
            <p id="lookupError" class="text-red-600 hidden text-sm mt-1"></p>
          </div>
          <div class="sm:col-span-4">
            <label>Nama Sekolah</label>
            <input id="namaSekolah" readonly class="border p-2 rounded w-full bg-gray-100" />
          </div>
          <div class="sm:col-span-3">
            <label>Daerah</label>
            <input id="daerahSekolah" readonly class="border p-2 rounded w-full bg-gray-100" />
          </div>
          <div class="sm:col-span-3">
            <label>Kategori</label>
            <input id="kategoriSekolah" readonly class="border p-2 rounded w-full bg-gray-100" />
          </div>
        </div>
      </div>

      <!-- B -->
      <div>
        <h3 class="font-semibold">Bahagian B: Maklumat Lawatan</h3>
        <div class="grid grid-cols-1 sm:grid-cols-6 gap-3 mt-3">
          <div class="sm:col-span-3">
            <label>Email Rasmi Sekolah</label>
            <input id="emailSekolah" type="email" required class="border p-2 rounded w-full" />
          </div>
          <div class="sm:col-span-3">
            <label>Nama Ketua Rombongan</label>
            <input id="namaKetuaRombongan" class="border p-2 rounded w-full" />
          </div>
          <div class="sm:col-span-3">
            <label>No Tel Ketua Rombongan</label>
            <input id="noTelKetuaRombongan" class="border p-2 rounded w-full" />
          </div>

          <div class="sm:col-span-3">
            <label>Tarikh Mula</label>
            <input id="tarikhMula" type="date" class="border p-2 rounded w-full" />
            <p id="tarikhError" class="text-red-600 hidden text-sm mt-1"></p>
          </div>
          <div class="sm:col-span-3">
            <label>Tarikh Akhir</label>
            <input id="tarikhAkhir" type="date" class="border p-2 rounded w-full" />
          </div>

          <div class="sm:col-span-6">
            <label>Tempat Lawatan</label>
            <textarea id="tempatLawatan" class="border p-2 rounded w-full"></textarea>
          </div>
          <div class="sm:col-span-6">
            <label>Alamat Penginapan</label>
            <textarea id="alamatPenginapan" class="border p-2 rounded w-full"></textarea>
          </div>
        </div>
      </div>

      <!-- C (files) -->
      <div>
        <h3 class="font-semibold">Bahagian C: Muat Naik Dokumen</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
          <div>
            <label>Kertas Kerja (PDF)</label>
            <input id="kertasKerja" type="file" accept=".pdf" class="w-full" />
          </div>
          <div>
            <label>Maklumat Anggota (PDF)</label>
            <input id="maklumatAnggota" type="file" accept=".pdf" class="w-full" />
          </div>
          <div>
            <label>Lesen Bas</label>
            <input id="lampiranLesenBas" type="file" accept=".pdf,image/*" class="w-full" />
          </div>
          <div>
            <label>Lesen Pemandu</label>
            <input id="lampiranLesenPemandu" type="file" accept=".pdf,image/*" class="w-full" />
          </div>
          <div class="sm:col-span-2">
            <label>Intipati Taklimat Keselamatan</label>
            <input id="lampiranTaklimat" type="file" accept=".pdf,image/*" class="w-full" />
          </div>
        </div>
      </div>

      <!-- D: Kewangan -->
      <div>
        <h3 class="font-semibold">Bahagian D: Maklumat Kewangan</h3>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-6 gap-3 items-end">
          <div class="sm:col-span-2 font-semibold">Sumber</div>
          <div class="font-semibold">Bil</div>
          <div class="font-semibold">Kutipan Seorang (RM)</div>
          <div class="font-semibold">Jumlah (RM)</div>

          <div class="sm:col-span-2">Murid</div>
          <div><input id="kew_murid_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_murid_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_murid_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-2">Guru</div>
          <div><input id="kew_guru_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_guru_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_guru_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-2">Akaun Sekolah (PCG)</div>
          <div><input id="kew_pcg_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_pcg_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_pcg_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-2">Akaun Sekolah (LPBT)</div>
          <div><input id="kew_lpbt_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_lpbt_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_lpbt_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-2">Asrama (BMA)</div>
          <div><input id="kew_bma_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_bma_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_bma_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-2">Asrama (BPP)</div>
          <div><input id="kew_bpp_bil" type="number" value="0" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_bpp_kutipan" type="number" step="0.01" value="0.00" class="border p-2 rounded w-full" /></div>
          <div><input id="kew_bpp_jumlah" readonly value="0.00" class="border p-2 rounded w-full bg-gray-100" /></div>

          <div class="sm:col-span-4 text-right font-semibold">Jumlah Keseluruhan (RM)</div>
          <div class="sm:col-span-2"><input id="kew_jumlah_besar" readonly value="0.00" class="border p-2 rounded w-full bg-gray-200 font-bold" /></div>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button id="submitButton" type="button" class="bg-blue-600 text-white btn">Hantar Permohonan</button>
      </div>
    </form>

    <div id="formSuccess" class="hidden success-popup">
      <strong>Permohonan berjaya dihantar!</strong>
      <div>ID: <span id="successId"></span></div>
    </div>

    <div id="formError" class="hidden mt-3 p-3 bg-red-50 border border-red-200 text-red-700 rounded">Ralat: <span id="formErrorText"></span></div>
  </section>

  <!-- DASHBOARD TAB -->
  <section id="tabDashboard" class="card hidden">
    <h2 class="text-xl font-semibold mb-3">Dashboard JPN</h2>
    <p class="text-sm text-gray-600 mb-3">Masukkan kata laluan untuk memuatkan data permohonan.</p>
    <div class="flex gap-3 mb-4">
      <input id="dashboardToken" type="password" placeholder="Kata Laluan" class="border p-2 rounded" />
      <button id="btnLoadData" class="bg-blue-600 text-white btn">Muatkan Data</button>
      <select id="filterKategori" class="border p-2 rounded">
        <option value="">Semua Kategori</option>
        <option value="RENDAH">RENDAH</option>
        <option value="MENENGAH">MENENGAH</option>
      </select>
    </div>

    <div id="dashboardMsg" class="mb-3 text-sm text-red-600 hidden"></div>

    <div id="dashboardTableWrap" class="table-scroll hidden">
      <table id="dashboardTable" class="min-w-full border-collapse">
      </table>
    </div>
  </section>

  <section id="tabKelulusan" class="card hidden">
    <h2 class="text-xl font-semibold">Kelulusan Pengarah</h2>
    <p class="small">Bahagian ini akan diaktifkan selepas proses semakan JPN (akan dibangunkan jika perlu).</p>
  </section>
</div>

<!-- Modal view -->
<div id="modalView" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4">
  <div class="bg-white p-4 rounded w-full max-w-3xl">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-semibold">Butiran Permohonan</h3>
      <button id="closeModal" class="bg-gray-200 p-1 rounded">Tutup</button>
    </div>
    <div id="modalContent" style="max-height:60vh; overflow:auto;"></div>
  </div>
</div>

<script>
/* ==================== KONFIGURASI FRONTEND ==================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXfvUGbXGZ8X-8OVhGRI4Y8-HJaXUbStnkiSj_DvwnqCuyPAl9eQOgNoZn1iru85lE/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSRZ4X7exDV-Bu9BSV0IjGswnQjpoYBgXBT-llAz2Iwr4z8fGWV0VX-DWzzYAEMmq-CWGqlXDayGYED/pub?gid=0&single=true&output=csv";
const SECRET_TOKEN = "12345";
/* ============================================================ */

let DATABASE_SEKOLAH = null;

/* helper */
const el = id => document.getElementById(id);

/* Tabs */
const tabs = { form: el('tabForm'), dashboard: el('tabDashboard'), kelulusan: el('tabKelulusan') };
const btns = { form: el('tabBtnForm'), dashboard: el('tabBtnDashboard'), kelulusan: el('tabBtnKelulusan') };
btns.form.addEventListener('click', ()=> showTab('form'));
btns.dashboard.addEventListener('click', ()=> showTab('dashboard'));
btns.kelulusan.addEventListener('click', ()=> showTab('kelulusan'));
function showTab(name){
  for (const k in tabs) tabs[k].classList.add('hidden');
  for (const k in btns) btns[k].classList.remove('tab-active');
  tabs[name].classList.remove('hidden'); btns[name].classList.add('tab-active');
}
showTab('form');

/* DOM refs used in code */
const elKod = el('kodSekolah'), elNama = el('namaSekolah'), elDaerah = el('daerahSekolah'), elKategori = el('kategoriSekolah');
const elDbStatus = el('dbStatus');

/* ---------- Load school CSV DB ---------- */
async function loadSchoolDatabase(){
  try {
    elDbStatus.textContent = 'Memuatkan pangkalan data sekolah...';
    elDbStatus.className = 'mb-4 p-3 bg-blue-50 text-blue-700 rounded';
    if (!CSV_URL || CSV_URL.includes('URL_CSV_ANDA')) throw new Error('Sila kemas kini CSV_URL dalam index.html');
    const r = await fetch(CSV_URL);
    if (!r.ok) throw new Error('Gagal muat turun CSV (status ' + r.status + ')');
    let raw = await r.text();
    raw = raw.replace(/^\uFEFF/, '');
    if (!raw.trim()) throw new Error('CSV kosong');
    // simple robust CSV parse (handles quotes)
    function parseCSV(text){
      const rows=[]; let cur=''; let row=[]; let inQ=false;
      for (let i=0;i<text.length;i++){
        const ch=text[i], next=text[i+1];
        if (ch === '"'){ if (inQ && next === '"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if (ch === ',' && !inQ){ row.push(cur); cur=''; }
        else if ((ch === '\n' || ch === '\r') && !inQ){ row.push(cur); cur=''; rows.push(row); row=[]; if (ch === '\r' && text[i+1] === '\n') i++; }
        else cur+=ch;
      }
      if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }
    const rows = parseCSV(raw);
    if (!rows || rows.length < 1) throw new Error('Tiada baris dalam CSV');
    const rawHeaders = rows[0].map(h => (h||'').toString().trim());
    const norm = rawHeaders.map(h => h.replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').toUpperCase());
    function findHeaderIdx(possible){ for(const p of possible){ const t = p.replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').toUpperCase(); const i = norm.indexOf(t); if (i !== -1) return i; } return -1; }
    const idxKod = findHeaderIdx(['KOD_SEKOLAH','KOD SEKOLAH','KODSEKOLAH']);
    const idxNama = findHeaderIdx(['NAMA_SEKOLAH','NAMA SEKOLAH','NAMA_SEKOLAH']);
    const idxDaerah = findHeaderIdx(['DAERAH']);
    const idxKategori = findHeaderIdx(['KATEGORI']);
    if (idxKod === -1 || idxNama === -1) {
      elDbStatus.textContent = "Format CSV tidak sah. Pastikan header betul.";
      elDbStatus.className = 'mb-4 p-3 bg-red-50 text-red-700 rounded';
      return;
    }
    const db = {};
    for (let i=1;i<rows.length;i++){
      const r = rows[i];
      const kod = (r[idxKod]||'').toString().trim().toUpperCase();
      if (!kod) continue;
      db[kod] = { nama: (r[idxNama]||'').toString().trim(), daerah: idxDaerah !== -1 ? (r[idxDaerah]||'').toString().trim() : '', kategori: idxKategori !== -1 ? (r[idxKategori]||'').toString().trim() : '' };
    }
    DATABASE_SEKOLAH = db;
    elDbStatus.textContent = `STATUS: Pangkalan data sekolah sedia (${Object.keys(db).length} rekod).`;
    elDbStatus.className = 'mb-4 p-3 bg-green-50 text-green-800 rounded';
    elKod.disabled = false;
  } catch (err) {
    console.error('loadSchoolDatabase error:', err);
    DATABASE_SEKOLAH = null;
    elDbStatus.textContent = 'Format CSV tidak sah. Pastikan header betul. ' + (err.message||'');
    elDbStatus.className = 'mb-4 p-3 bg-red-50 text-red-700 rounded';
    try { elKod.disabled = false; } catch(e){}
  }
}
loadSchoolDatabase();

/* ---------- Lookup sekolah when kod entered ---------- */
elKod.addEventListener('blur', lookupSekolah);
function lookupSekolah(){
  const kod = (elKod.value||'').toString().trim().toUpperCase();
  if (!kod) { clearSekolah(); return; }
  if (!DATABASE_SEKOLAH) { showLookupError('DB belum sedia.'); return; }
  const rec = DATABASE_SEKOLAH[kod];
  if (!rec) { showLookupError('Kod tidak ditemui.'); clearSekolah(); return; }
  elNama.value = rec.nama; elDaerah.value = rec.daerah; elKategori.value = rec.kategori; hideLookupError();
}
function clearSekolah(){ elKod.value=''; elNama.value=''; elDaerah.value=''; elKategori.value=''; }
function showLookupError(msg){ const elu = el('lookupError'); elu.textContent = msg; elu.classList.remove('hidden'); }
function hideLookupError(){ const elu = el('lookupError'); elu.classList.add('hidden'); }

/* ---------- Modes (baru/query) ---------- */
el('modeNew').addEventListener('click', ()=> { el('querySection').classList.add('hidden'); el('isQueryMode').value='false'; resetFormFull(); });
el('modeQuery').addEventListener('click', ()=> { el('querySection').classList.remove('hidden'); el('isQueryMode').value='true'; });

/* ---------- Query lookup ---------- */
el('btnQueryLookup').addEventListener('click', doQueryLookup);
async function doQueryLookup(){
  const id = el('queryId').value.trim(); const email = el('queryEmail').value.trim();
  if (!id || !email) { el('queryError').textContent = 'Sila isi ID dan E-mel.'; el('queryError').classList.remove('hidden'); return; }
  el('queryError').classList.add('hidden');
  el('btnQueryLookup').disabled = true; el('btnQueryLookup').textContent = 'Mencari...';
  try {
    const r = await fetch(`${SCRIPT_URL}?action=getPermohonanForEdit&id=${encodeURIComponent(id)}&email=${encodeURIComponent(email)}`);
    const data = await r.json();
    if (data.status === 'success') {
      fillFormFromData(data.data);
      el('currentId').value = id;
      el('querySection').classList.add('hidden');
      el('dbStatus').textContent = `Membuka permohonan ${id} untuk edit.`;
    } else {
      el('queryError').textContent = data.message || 'Ralat';
      el('queryError').classList.remove('hidden');
    }
  } catch (e) {
    console.error(e); el('queryError').textContent = 'Ralat sambungan: ' + e.message; el('queryError').classList.remove('hidden');
  } finally {
    el('btnQueryLookup').disabled = false; el('btnQueryLookup').textContent = 'Cari';
  }
}

/* ---------- fill form from data (Query) ---------- */
function fillFormFromData(d) {
  elKod.value = d['Kod Sekolah'] || d['KodSekolah'] || '';
  lookupSekolah();
  el('emailSekolah').value = d['Email Rasmi Sekolah'] || d['Email'] || '';
  if (d['Tarikh Mula']) el('tarikhMula').value = (new Date(d['Tarikh Mula'])).toISOString().split('T')[0];
  if (d['Tarikh Akhir']) el('tarikhAkhir').value = (new Date(d['Tarikh Akhir'])).toISOString().split('T')[0];
  el('namaKetuaRombongan').value = d['Nama Ketua Rombongan'] || '';
  el('noTelKetuaRombongan').value = d['No Tel Ketua Rombongan'] || '';
  el('tempatLawatan').value = d['Tempat Lawatan'] || '';
  el('alamatPenginapan').value = d['Alamat Penginapan'] || '';
  // kewangan
  setIfExists('kew_murid_bil', d['Kewangan_Murid_Bil']); setIfExists('kew_murid_kutipan', d['Kewangan_Murid_Kutipan']); setIfExists('kew_murid_jumlah', d['Kewangan_Murid_Jumlah']);
  setIfExists('kew_guru_bil', d['Kewangan_Guru_Bil']); setIfExists('kew_guru_kutipan', d['Kewangan_Guru_Kutipan']); setIfExists('kew_guru_jumlah', d['Kewangan_Guru_Jumlah']);
  setIfExists('kew_pcg_bil', d['Kewangan_AkaunSek_PCG_Bil']); setIfExists('kew_pcg_kutipan', d['Kewangan_AkaunSek_PCG_Kutipan']); setIfExists('kew_pcg_jumlah', d['Kewangan_AkaunSek_PCG_Jumlah']);
  setIfExists('kew_lpbt_bil', d['Kewangan_AkaunSek_LPBT_Bil']); setIfExists('kew_lpbt_kutipan', d['Kewangan_AkaunSek_LPBT_Kutipan']); setIfExists('kew_lpbt_jumlah', d['Kewangan_AkaunSek_LPBT_Jumlah']);
  setIfExists('kew_bma_bil', d['Kewangan_Asrama_BMA_Bil']); setIfExists('kew_bma_kutipan', d['Kewangan_Asrama_BMA_Kutipan']); setIfExists('kew_bma_jumlah', d['Kewangan_Asrama_BMA_Jumlah']);
  setIfExists('kew_bpp_bil', d['Kewangan_Asrama_BPP_Bil']); setIfExists('kew_bpp_kutipan', d['Kewangan_Asrama_BPP_Kutipan']); setIfExists('kew_bpp_jumlah', d['Kewangan_Asrama_BPP_Jumlah']);
  setIfExists('kew_jumlah_besar', d['Kewangan_Jumlah_Besar'] || d['Kewangan_Jumlah_Besar']);
  calculateKewangan();
}
function setIfExists(id,val){ if (val !== undefined && el(id)) el(id).value = val; }

/* ---------- Reset form ---------- */
function resetFormFull(){
  document.getElementById('mainForm').reset();
  clearSekolah();
  calculateKewangan();
  el('currentId').value = '';
  el('formError').classList.add('hidden'); el('formErrorText').textContent = '';
}

/* ---------- Kewangan calc ---------- */
const kewIds = ['murid','guru','pcg','lpbt','bma','bpp'];
kewIds.forEach(id => {
  const bil = el(`kew_${id}_bil`); const kut = el(`kew_${id}_kutipan`);
  if (bil) bil.addEventListener('input', calculateKewangan); if (kut) kut.addEventListener('input', calculateKewangan);
});
function calculateKewangan(){
  let total = 0;
  kewIds.forEach(id => {
    const elBil = el(`kew_${id}_bil`); const elKutipan = el(`kew_${id}_kutipan`); const elJumlah = el(`kew_${id}_jumlah`);
    const bil = parseFloat(elBil ? elBil.value : 0) || 0; const kut = parseFloat(elKutipan ? elKutipan.value : 0) || 0;
    const j = bil * kut;
    if (elJumlah) elJumlah.value = j.toFixed(2);
    total += j;
  });
  el('kew_jumlah_besar').value = total.toFixed(2);
}

/* ---------- Tarikh validation (>=30 hari) ---------- */
function daysBetween(d1,d2){ return Math.round((d2.getTime()-d1.getTime())/(24*3600*1000)); }
function validateTarikh(){
  el('tarikhError').classList.add('hidden');
  const tM = el('tarikhMula').value; if (!tM) return true;
  const tarikhM = new Date(tM + 'T00:00:00'); const today = new Date(); today.setHours(0,0,0,0);
  const diff = daysBetween(today, tarikhM);
  if (diff < 30) { el('tarikhError').textContent = `Tarikh mula mesti sekurang-kurangnya 30 hari dari hari ini. (Baki ${diff} hari)`; el('tarikhError').classList.remove('hidden'); return false; }
  return true;
}
el('tarikhMula').addEventListener('change', validateTarikh);

/* ---------- form submit ---------- */
el('submitButton').addEventListener('click', handleFormSubmit);
async function handleFormSubmit(e){
  e.preventDefault();
  el('formError').classList.add('hidden'); el('formErrorText').textContent = '';
  if (!el('namaSekolah').value) { showFormError('Sila masukkan Kod Sekolah yang sah.'); return; }
  if (!validateTarikh()) { showFormError('Tarikh mula tidak sah.'); return; }

  const isQuery = el('isQueryMode').value === 'true';
  // require files for new submission
  const fileInputs = { kertasKerja: el('kertasKerja'), maklumatAnggota: el('maklumatAnggota'), lampiranLesenBas: el('lampiranLesenBas'), lampiranLesenPemandu: el('lampiranLesenPemandu'), lampiranTaklimat: el('lampiranTaklimat') };
  if (!isQuery) {
    const missing = Object.keys(fileInputs).filter(k => !(fileInputs[k] && fileInputs[k].files && fileInputs[k].files[0]));
    if (missing.length > 0) { showFormError('Sila pastikan semua fail dimuat naik (5 fail).'); return; }
  }

  // read files
  const filePromises = [];
  for (const k in fileInputs) {
    const fi = fileInputs[k];
    if (fi && fi.files && fi.files[0]) {
      filePromises.push(readFileAsBase64(fi.files[0]).then(b64 => ({ key: k, file: fi.files[0], data: b64 })));
    }
  }

  try {
    const fileObjs = await Promise.all(filePromises);
    const filesPayload = {};
    fileObjs.forEach(o => filesPayload[o.key] = { filename: o.file.name, mimeType: o.file.type || 'application/octet-stream', data: o.data.split(',')[1] });

    const kew = {};
    kew['Kewangan_Murid_Bil'] = el('kew_murid_bil').value || 0;
    kew['Kewangan_Murid_Kutipan'] = el('kew_murid_kutipan').value || 0;
    kew['Kewangan_Murid_Jumlah'] = el('kew_murid_jumlah').value || 0;
    kew['Kewangan_Guru_Bil'] = el('kew_guru_bil').value || 0;
    kew['Kewangan_Guru_Kutipan'] = el('kew_guru_kutipan').value || 0;
    kew['Kewangan_Guru_Jumlah'] = el('kew_guru_jumlah').value || 0;
    kew['Kewangan_AkaunSek_PCG_Bil'] = el('kew_pcg_bil').value || 0;
    kew['Kewangan_AkaunSek_PCG_Kutipan'] = el('kew_pcg_kutipan').value || 0;
    kew['Kewangan_AkaunSek_PCG_Jumlah'] = el('kew_pcg_jumlah').value || 0;
    kew['Kewangan_AkaunSek_LPBT_Bil'] = el('kew_lpbt_bil').value || 0;
    kew['Kewangan_AkaunSek_LPBT_Kutipan'] = el('kew_lpbt_kutipan').value || 0;
    kew['Kewangan_AkaunSek_LPBT_Jumlah'] = el('kew_lpbt_jumlah').value || 0;
    kew['Kewangan_Asrama_BMA_Bil'] = el('kew_bma_bil').value || 0;
    kew['Kewangan_Asrama_BMA_Kutipan'] = el('kew_bma_kutipan').value || 0;
    kew['Kewangan_Asrama_BMA_Jumlah'] = el('kew_bma_jumlah').value || 0;
    kew['Kewangan_Asrama_BPP_Bil'] = el('kew_bpp_bil').value || 0;
    kew['Kewangan_Asrama_BPP_Kutipan'] = el('kew_bpp_kutipan').value || 0;
    kew['Kewangan_Asrama_BPP_Jumlah'] = el('kew_bpp_jumlah').value || 0;
    kew['Kewangan_Jumlah_Besar'] = el('kew_jumlah_besar').value || 0;

    const payload = {
      action: isQuery ? "resubmitPermohonan" : "submitPermohonan",
      idPermohonan: el('currentId').value || "",
      "Email Rasmi Sekolah": el('emailSekolah').value || "",
      "Kod Sekolah": el('kodSekolah').value || "",
      "Nama Sekolah": el('namaSekolah').value || "",
      "Daerah": el('daerahSekolah').value || "",
      "Kategori": el('kategoriSekolah').value || "",
      "Tarikh Mula": el('tarikhMula').value || "",
      "Tarikh Akhir": el('tarikhAkhir').value || "",
      "Nama Ketua Rombongan": el('namaKetuaRombongan').value || "",
      "No Tel Ketua Rombongan": el('noTelKetuaRombongan').value || "",
      "Tempat Lawatan": el('tempatLawatan').value || "",
      "Alamat Penginapan": el('alamatPenginapan').value || "",
      files: filesPayload,
      kewangan: kew
    };

    // send as text/plain to avoid preflight
    const resp = await fetch(SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
    const data = await resp.json();
    if (data.status === 'success') {
      const id = isQuery ? el('currentId').value : data.idPermohonan;
      el('successId').textContent = id;
      el('formSuccess').classList.remove('hidden');
      setTimeout(()=> { el('formSuccess').classList.add('hidden'); resetFormFull(); }, 5000);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else showFormError(data.message || 'Ralat tidak diketahui');
  } catch (err) {
    console.error(err); showFormError('Gagal hantar: ' + err.message);
  }
}

function showFormError(msg){ el('formErrorText').textContent = msg; el('formError').classList.remove('hidden'); }

function readFileAsBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); r.readAsDataURL(file); }); }

/* ---------- Dashboard ---------- */
el('btnLoadData').addEventListener('click', loadDashboardData);
el('closeModal').addEventListener('click', ()=> el('modalView').classList.add('hidden'));

async function loadDashboardData(){
  el('dashboardMsg').classList.add('hidden');
  const token = el('dashboardToken').value.trim();
  if (!token) { el('dashboardMsg').textContent = 'Sila masukkan kata laluan'; el('dashboardMsg').classList.remove('hidden'); return; }
  try {
    const r = await fetch(`${SCRIPT_URL}?action=getData&token=${encodeURIComponent(token)}`);
    const data = await r.json();
    if (data.status === 'success') {
      el('dashboardTableWrap').classList.remove('hidden');
      renderDashboardTable(data.data || []);
    } else {
      el('dashboardMsg').textContent = data.message || 'Ralat'; el('dashboardMsg').classList.remove('hidden');
    }
  } catch (e) { console.error(e); el('dashboardMsg').textContent = 'Gagal muat data: ' + e.message; el('dashboardMsg').classList.remove('hidden'); }
}

function renderDashboardTable(rows){
  const tbl = el('dashboardTable');
  const headers = ['Timestamp','Email Rasmi Sekolah','Kod Sekolah','Nama Sekolah','Daerah','Kategori','Tarikh Mula','Tarikh Akhir','Tempat Lawatan','Alamat Penginapan','ID Permohonan','Status Permohonan','Catatan Query','Disemak Oleh','Link Kertas Kerja','Link Maklumat Anggota','Link Lesen Bas','Link Lesen Pemandu','Link Taklimat_Keselamatan','Tindakan'];
  let html = '<thead class="bg-gray-50"><tr>';
  headers.forEach(h => html += `<th class="p-3 border-b text-left">${h}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r => {
    html += '<tr>';
    headers.forEach(h => {
      if (h === 'Tindakan') {
        const id = r['ID Permohonan'] || r['IDPermohonan'] || '';
        html += `<td class="p-2 border-b">
                  <button data-id="${id}" class="viewBtn bg-gray-100 p-1 rounded mr-1">Lihat</button>
                  <button data-id="${id}" class="queryBtn bg-yellow-300 p-1 rounded mr-1">Query</button>
                  <button data-id="${id}" class="lulusBtn bg-green-500 text-white p-1 rounded">Lulus JPN</button>
                 </td>`;
      } else {
        let cell = r[h] || r[h.replace(/ /g,'_')] || '';
        if (typeof cell === 'string' && cell.startsWith && cell.startsWith('https://drive.google.com')) {
          cell = `<a class="link-file" href="${cell}" target="_blank">Lihat Fail</a>`;
        } else if (cell && typeof cell === 'string' && cell.startsWith && cell.startsWith('http')) {
          cell = `<a class="small link-file" href="${cell}" target="_blank">${cell}</a>`;
        }
        html += `<td class="p-2 border-b align-top">${cell}</td>`;
      }
    });
    html += '</tr>';
  });
  html += '</tbody>';
  tbl.innerHTML = html;

  Array.from(document.getElementsByClassName('viewBtn')).forEach(b => b.addEventListener('click', onViewRecord));
  Array.from(document.getElementsByClassName('queryBtn')).forEach(b => b.addEventListener('click', onQueryRecord));
  Array.from(document.getElementsByClassName('lulusBtn')).forEach(b => b.addEventListener('click', onLulusRecord));
}

async function onViewRecord(e){
  const id = e.currentTarget.dataset.id; openRecordModal(id);
}
async function openRecordModal(id){
  if (!id) return;
  try {
    const token = el('dashboardToken').value;
    const r = await fetch(`${SCRIPT_URL}?action=getData&token=${encodeURIComponent(token)}`);
    const data = await r.json();
    if (data.status !== 'success') { alert(data.message || 'Ralat'); return; }
    const row = (data.data || []).find(rr => (rr['ID Permohonan']||rr['IDPermohonan']||'') === id);
    if (!row) { alert('Rekod tidak ditemui'); return; }
    let html = '<div class="space-y-2">';
    for (const k in row) html += `<div><strong>${k}</strong><div>${row[k]||''}</div></div>`;
    html += '</div>';
    el('modalContent').innerHTML = html;
    el('modalView').classList.remove('hidden');
  } catch (err) { console.error(err); alert('Gagal buka rekod: ' + err.message); }
}

function onQueryRecord(e){
  const id = e.currentTarget.dataset.id;
  const note = prompt('Sila masukkan catatan Query untuk sekolah (akan dihantar melalui e-mel):');
  if (note === null) return;
  doUpdateStatus(id, 'Query', note);
}
function onLulusRecord(e){
  const id = e.currentTarget.dataset.id;
  if (!confirm('Sahkan Lulus JPN untuk ID: ' + id + ' ?')) return;
  doUpdateStatus(id, 'Lulus JPN', '');
}

async function doUpdateStatus(id, newStatus, note){
  const token = el('dashboardToken').value;
  const payload = { action: 'updateStatus', token: token, idPermohonan: id, newStatus: newStatus, note: note, reviewer: '' };
  try {
    const r = await fetch(SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
    const data = await r.json();
    if (data.status === 'success') { alert('Berjaya: ' + newStatus); loadDashboardData(); }
    else alert('Gagal: ' + (data.message||''));
  } catch (err) { console.error(err); alert('Ralat sambungan: ' + err.message); }
}

/* Done */
</script>
</body>
</html>
