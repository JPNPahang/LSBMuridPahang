/*
 * =================================================================
 * API SISTEM LAWATAN (GOOGLE APPS SCRIPT WEB APP)
 * VERSI 8.0 (MUKTAMAD - FASA 1)
 * =================================================================
 *
 * INI ADALAH KOD MUKTAMAD UNTUK FASA 1 (BORANG).
 *
 * 1. TIADA 'getSchoolInfo()': Carian sekolah kini diuruskan oleh CSV
 * di 'index.html', menyelesaikan ralat 'timeout'.
 * 2. doPost DIUBAH SUAI: Menerima 'Content-Type: text/plain' untuk
 * mengelak ralat CORS 'preflight' semasa hantar borang.
 * 3. doGet RINGKAS: Hanya ada 'getPermohonanForEdit' untuk mod Query.
 * 4. HEADER CORS LENGKAP: 'doOptions' dan 'createJsonResponse'
 * telah disediakan dengan betul.
 *
 * =================================================================
 */

// =================================================================
// BAHAGIAN KONFIGURASI (WAJIB UBAH)
// =================================================================

// v5.7: Kita akan guna spreadsheet yang aktif, bukan ID.
const SPREADSHEET_AKTIF = SpreadsheetApp.getActiveSpreadsheet();
const NAMA_SHEET_DATA = "Data";
// const NAMA_SHEET_SEKOLAH = "Senarai Sekolah"; // Tidak diperlukan lagi oleh GAS

// Dapatkan rujukan 'sheet' sekali sahaja untuk kecekapan
const SHEET_DATA = SPREADSHEET_AKTIF.getSheetByName(NAMA_SHEET_DATA);
// const SHEET_SEKOLAH = SPREADSHEET_AKTIF.getSheetByName(NAMA_SHEET_SEKOLAH); // Tidak diperlukan lagi

// ID Folder dari Google Drive (Fasa 1, Langkah 1)
const FOLDER_ID_KERTAS_KERJA = "1zzlknYMCl5NjMAHWXQzkzLjQ3Tb6tSi";
const FOLDER_ID_MAKLUMAT_ANGGOTA = "13weSFd-X5GQMHytJD9nx9p-UWrWqr9Ly";
const FOLDER_ID_SURAT_LULUS = "1yJncFi4KDNxOCvLmzm2ECNUS4RF_11El";
const FOLDER_ID_LESEN_BAS = "1vpbyBA6U-Mz1_OPh_Vs7kEDU1dhzkGGh";
const FOLDER_ID_LESEN_PEMANDU = "1qeeUvNgWLmJaVBZ52c4R_PvHnpiY5ZE8";
const FOLDER_ID_TAKLIMAT = "1_onRZBUbaslELzv_h7_VP_A39wXDNYgh";

// ID Templat Google Doc (Akan digunakan di Fasa Penuh)
const TEMPLATE_ID_SURAT_LULUS = "ID_TEMPLAT_GOOGLE_DOC_ANDA"; 

// KATA LALUAN RAHSIA untuk Pegawai JPN & Tertinggi
const KATA_LALUAN_RAHSIA = "12345"; // TUKAR INI

// E-MEL NOTIFIKASI
const EMAIL_PEGAWAI_JPN = "lsbspspahang@googlegroups.com"; // E-mel Google Group
const EMAIL_TIMBALAN_PENGARAH = "shabiel11@gmail.com"; // E-mel Pelulus

// Padanan Nombor Kolum untuk tab 'Data' (Fasa 2, Langkah 5)
// A=1, B=2, ..., AO=41
const COL_DATA = {
    Timestamp: 1,
    Email: 2,
    KodSekolah: 3,
    NamaSekolah: 4,
    Daerah: 5,
    Kategori: 6,
    TarikhMula: 7,
    TarikhAkhir: 8,
    TempatLawatan: 9,
    AlamatPenginapan: 10,
    NoTelPenginapan: 11,
    NamaKetuaRombongan: 12,
    NoTelKetuaRombongan: 13,
    LinkKertasKerja: 14,
    LinkMaklumatAnggota: 15,
    KewMuridBil: 16,
    KewMuridKutipan: 17,
    KewMuridJumlah: 18,
    KewGuruBil: 19,
    KewGuruKutipan: 20,
    KewGuruJumlah: 21,
    KewPcgBil: 22, // Kewangan_AkaunSek_PCG_Bil
    KewPcgKutipan: 23, // Kewangan_AkaunSek_PCG_Kutipan
    KewPcgJumlah: 24, // Kewangan_AkaunSek_PCG_Jumlah
    KewLpbtBil: 25, // Kewangan_AkaunSek_LPBT_Bil
    KewLpbtKutipan: 26, // Kewangan_AkaunSek_LPBT_Kutipan
    KewLpbtJumlah: 27, // Kewangan_AkaunSek_LPBT_Jumlah
    KewBmaBil: 28, // Kewangan_Asrama_BMA_Bil
    KewBmaKutipan: 29, // Kewangan_Asrama_BMA_Kutipan
    KewBmaJumlah: 30, // Kewangan_Asrama_BMA_Jumlah
    KewBppBil: 31, // Kewangan_Asrama_BPP_Bil
    KewBppKutipan: 32, // Kewangan_Asrama_BPP_Kutipan
    KewBppJumlah: 33, // Kewangan_Asrama_BPP_Jumlah
    KewJumlahBesar: 34,
    LinkLesenBas: 35,
    LinkLesenPemandu: 36, 
    LinkTaklimat: 37,
    IDPermohonan: 38,
    Status: 39,
    CatatanQuery: 40,
    DisemakOleh: 41 
};

// Map nama fail di HTML ke ID Folder & Kolum
const FILE_MAP = {
  "kertasKerja": { folderId: FOLDER_ID_KERTAS_KERJA, col: COL_DATA.LinkKertasKerja },
  "maklumatAnggota": { folderId: FOLDER_ID_MAKLUMAT_ANGGOTA, col: COL_DATA.LinkMaklumatAnggota },
  "lampiranLesenBas": { folderId: FOLDER_ID_LESEN_BAS, col: COL_DATA.LinkLesenBas },
  "lampiranLesenPemandu": { folderId: FOLDER_ID_LESEN_PEMANDU, col: COL_DATA.LinkLesenPemandu }, 
  "lampiranTaklimat": { folderId: FOLDER_ID_TAKLIMAT, col: COL_DATA.LinkTaklimat }
};

// Map nama medan kewangan di HTML ke Kolum
const KEWANGAN_MAP = {
  "Kewangan_AkaunSek_PCG_Bil": COL_DATA.KewPcgBil,
  "Kewangan_AkaunSek_PCG_Kutipan": COL_DATA.KewPcgKutipan,
  "Kewangan_AkaunSek_PCG_Jumlah": COL_DATA.KewPcgJumlah,
  "Kewangan_AkaunSek_LPBT_Bil": COL_DATA.KewLpbtBil,
  "Kewangan_AkaunSek_LPBT_Kutipan": COL_DATA.KewLpbtKutipan,
  "Kewangan_AkaunSek_LPBT_Jumlah": COL_DATA.KewLpbtJumlah,
  "Kewangan_Asrama_BMA_Bil": COL_DATA.KewBmaBil,
  "Kewangan_Asrama_BMA_Kutipan": COL_DATA.KewBmaKutipan,
  "Kewangan_Asrama_BMA_Jumlah": COL_DATA.KewBmaJumlah,
  "Kewangan_Asrama_BPP_Bil": COL_DATA.KewBppBil,
  "Kewangan_Asrama_BPP_Kutipan": COL_DATA.KewBppKutipan,
  "Kewangan_Asrama_BPP_Jumlah": COL_DATA.KewBppJumlah,
  "Kewangan_Murid_Bil": COL_DATA.KewMuridBil,
  "Kewangan_Murid_Kutipan": COL_DATA.KewMuridKutipan,
  "Kewangan_Murid_Jumlah": COL_DATA.KewMuridJumlah,
  "Kewangan_Guru_Bil": COL_DATA.KewGuruBil,
  "Kewangan_Guru_Kutipan": COL_DATA.KewGuruKutipan,
  "Kewangan_Guru_Jumlah": COL_DATA.KewGuruJumlah,
  "Kewangan_Jumlah_Besar": COL_DATA.KewJumlahBesar
};


// =================================================================
// END OF KONFIGURASI
// =================================================================

/**
 * v7.1: Menjana output JSON standard dengan header CORS penuh.
 */
function createJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

/**
 * v7.1: Mengendalikan 'preflight' OPTIONS request untuk CORS
 */
function doOptions(e) {
  return createJsonResponse({ status: "success", message: "Preflight OK" });
}

/**
 * Fungsi utama untuk 'GET' request.
 * v8.0: DIBUANG 'getSchoolInfo' (kini diuruskan oleh CSV).
 */
function doGet(e) {
  try {
    const params = e.parameter || {}; // Jadikan 'params' selamat
    const action = params.action;
    
    // Tindakan ini 'public' (untuk borang query)
    if (action === "getPermohonanForEdit") {
      return getPermohonanForEdit(params.id, params.email);
    }
    
    // Tindakan 'private' (Dashboard)
    if (params.token !== KATA_LALUAN_RAHSIA) {
      return createJsonResponse({ status: "error", message: "Unauthorized: Token tidak sah" });
    }
    
    if (action === "getData") {
      // (Akan dibina di Fasa Penuh)
      // return getAllData(); 
    }
    
    return createJsonResponse({ status: "error", message: "Invalid action" });

  } catch (error) {
    Logger.log(`doGet Error: ${error.stack}`);
    return createJsonResponse({ status: "error", message: error.message });
  }
}

/**
 * v7.1: Fungsi utama untuk 'POST' request.
 * Menerima 'Content-Type: text/plain' bagi mengelak preflight.
 */
function doPost(e) {
  let payload;
  try {
    // 1. Semak jika postData wujud
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('Tiada postData. Pastikan Content-Type: text/plain dihantar.');
    }

    // 2. Parse string 'text/plain' sebagai JSON
    const rawData = e.postData.contents;
    try {
      payload = JSON.parse(rawData);
    } catch (parseError) {
      throw new Error(`JSON parsing gagal: ${parseError.message}. Data diterima: ${rawData}`);
    }

    // 3. Sahkan 'action'
    const action = payload.action;
    if (!action) {
      throw new Error('Invalid action: ' + action);
    }

    // 4. Laksanakan 'action' (Fasa 1)
    if (action === "submitPermohonan") {
      return submitPermohonan(payload);
    }
    if (action === "resubmitPermohonan") {
      return resubmitPermohonan(payload);
    }

    // 5. Laksanakan 'action' (Fasa Penuh - Perlukan Token)
    if (payload.token !== KATA_LALUAN_RAHSIA) {
       throw new Error('Unauthorized: Token tidak sah');
    }

    if (action === "updateStatus") {
      // (Akan dibina di Fasa Penuh)
      // return updateStatus(payload);
    }
    if (action === "janaSurat") {
      // (Akan dibina di Fasa Penuh)
      // return janaDanHantarSurat(payload);
    }

    throw new Error('Invalid private action: ' + action);

  } catch (error) {
    Logger.log(`doPost Error: ${error.stack}`);
    return createJsonResponse({ status: "error", message: error.message });
  }
}

// =================================================================
// FUNGSI-FUNGSI API (FASA 1)
// =================================================================

/**
 * [GET] Mencari data permohonan untuk diisi semula (pre-fill).
 */
function getPermohonanForEdit(id, email) {
   if (!id || !email) {
    return createJsonResponse({ status: "error", message: "ID Permohonan dan E-mel diperlukan." });
  }

  const { sheet, rowNum, rowData } = findRowById(id);
  if (rowNum === -1) {
    return createJsonResponse({ status: "error", message: "ID Permohonan tidak ditemui." });
  }
  
  // Sahkan E-mel dan Status
  const emailSheet = (rowData[COL_DATA.Email - 1] || '').toString().trim();
  const statusSheet = (rowData[COL_DATA.Status - 1] || '').toString().trim();
  
  if (emailSheet.toLowerCase() !== email.trim().toLowerCase()) {
    return createJsonResponse({ status: "error", message: "E-mel tidak sepadan dengan ID Permohonan." });
  }
  
  if (statusSheet !== "Query") {
    return createJsonResponse({ status: "error", message: `Permohonan ini berstatus "${statusSheet}", bukan "Query". Pembetulan tidak dibenarkan.` });
  }

  // Dapatkan semua data dari baris itu
  const headers = SHEET_DATA.getRange(1, 1, 1, SHEET_DATA.getMaxColumns()).getValues()[0];
  const dataToReturn = {};
  headers.forEach((header, index) => {
    // Format tarikh sebagai YYYY-MM-DD
    if (index === COL_DATA.TarikhMula - 1 || index === COL_DATA.TarikhAkhir - 1) {
        if (rowData[index] instanceof Date) {
             dataToReturn[header] = rowData[index].toISOString().split('T')[0];
        } else {
             // Jika ia string (mungkin dari import), cuba pastikan ia YYYY-MM-DD
             try {
                dataToReturn[header] = new Date(rowData[index]).toISOString().split('T')[0];
             } catch(e) {
                dataToReturn[header] = rowData[index]; // Guna nilai asal jika gagal
             }
        }
    } else {
         dataToReturn[header] = rowData[index];
    }
  });
  
  return createJsonResponse({ status: "success", data: dataToReturn });
}


/**
 * [POST] Menerima hantaran borang baru.
 */
function submitPermohonan(payload) {
  try {
    const sheet = SHEET_DATA;
    
    // 1. Jana ID unik
    const timestamp = new Date();
    const idPermohonan = `JPNP-${timestamp.getFullYear()}${(timestamp.getMonth() + 1).toString().padStart(2, '0')}${timestamp.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random() * 1000)}`;
    
    // 2. Bina baris baru
    const newRow = new Array(sheet.getMaxColumns()).fill(""); 

    newRow[COL_DATA.Timestamp - 1] = timestamp;
    newRow[COL_DATA.IDPermohonan - 1] = idPermohonan;
    newRow[COL_DATA.Status - 1] = "Baru";
    
    // 3. Isi data dari payload
    fillRowData(newRow, payload);
    
    // 4. Uruskan fail
    for (const fileName in payload.files) {
      if (FILE_MAP[fileName]) {
        const fileData = payload.files[fileName];
        const folderId = FILE_MAP[fileName].folderId;
        const file = createFile(fileData, folderId, idPermohonan); // Hantar ID untuk nama unik
        newRow[FILE_MAP[fileName].col - 1] = file.getUrl(); 
      }
    }

    // 5. Tambah baris baru
    sheet.appendRow(newRow);
    
    // 6. Hantar e-mel pengesahan (ke sekolah)
    GmailApp.sendEmail(payload["Email Rasmi Sekolah"],
      `Permohonan Lawatan Diterima - ${idPermohonan}`,
      `Permohonan anda telah diterima.\n\nID Permohonan: ${idPermohonan}\nStatus: Baru\n\nAnda akan dimaklumkan jika ada sebarang kemas kini.`
    );
    
    // 7. Hantar notifikasi (ke pegawai JPN)
    sendNotificationEmail(EMAIL_PEGAWAI_JPN,
      `Notifikasi Permohonan Baru: ${idPermohonan}`,
      `Permohonan baru telah diterima daripada ${payload["Nama Sekolah"]}.\n\nID Permohonan: ${idPermohonan}\nStatus: Baru\n\nSila log masuk ke dashboard untuk semakan.`
    );

    return createJsonResponse({ status: "success", idPermohonan: idPermohonan });
  } catch (error) {
    Logger.log(`submitPermohonan Error: ${error.stack}`);
    return createJsonResponse({ status: "error", message: `Ralat Hantar: ${error.message}` });
  }
}

/**
 * [POST] Menerima hantaran semula borang (Query).
 */
function resubmitPermohonan(payload) {
   try {
    const idPermohonan = payload.idPermohonan;
    if (!idPermohonan) {
      return createJsonResponse({ status: "error", message: "ID Permohonan diperlukan untuk hantar semula." });
    }
    
    const { sheet, rowNum, rowData } = findRowById(idPermohonan);
    if (rowNum === -1) {
      return createJsonResponse({ status: "error", message: "ID Permohonan tidak ditemui." });
    }
    
    // 1. Kemas kini data dalam 'rowData'
    rowData[COL_DATA.Status - 1] = "Baru"; // Tukar status kembali ke 'Baru'
    rowData[COL_DATA.CatatanQuery - 1] = ""; // Kosongkan catatan query
    rowData[COL_DATA.DisemakOleh - 1] = ""; // Kosongkan 'Disemak Oleh'
    fillRowData(rowData, payload); // Isi data borang yang baru
    
    // 2. Uruskan fail (Hanya ganti jika fail baru dimuat naik)
    for (const fileName in payload.files) {
      if (FILE_MAP[fileName] && payload.files[fileName]) {
        const fileData = payload.files[fileName];
        const folderId = FILE_MAP[fileName].folderId;
        const file = createFile(fileData, folderId, idPermohonan); // Hantar ID untuk nama unik
        rowData[FILE_MAP[fileName].col - 1] = file.getUrl(); // Ganti link lama
      }
    }
    
    // 3. Tulis semula keseluruhan baris ke Sheet
    sheet.getRange(rowNum, 1, 1, rowData.length).setValues([rowData]);

    // 4. Hantar e-mel pengesahan (ke sekolah)
    GmailApp.sendEmail(payload["Email Rasmi Sekolah"],
      `Permohonan Lawatan Dihantar Semula - ${idPermohonan}`,
      `Permohonan anda (ID: ${idPermohonan}) telah berjaya dikemas kini dan dihantar semula untuk semakan.\n\nStatus: Baru\n\nTerima kasih.`
    );
    
    // 5. Hantar notifikasi (ke pegawai JPN)
    sendNotificationEmail(EMAIL_PEGAWAI_JPN,
      `Notifikasi Query Dihantar Semula: ${idPermohonan}`,
      `Permohonan (ID: ${idPermohonan}) telah dihantar semula oleh ${payload["Nama Sekolah"]} selepas Query.\n\nStatus: Baru\n\nSila log masuk ke dashboard untuk semakan.`
    );
    
    return createJsonResponse({ status: "success", idPermohonan: idPermohonan });

  } catch (error) {
    Logger.log(`resubmitPermohonan Error: ${error.stack}`);
    return createJsonResponse({ status: "error", message: `Ralat Hantar Semula: ${error.message}` });
  }
}

// =================================================================
// FUNGSI SOKONGAN (UTILITIES)
// =================================================================

/**
 * v7.1: Mencari baris berdasarkan ID Permohonan (Lebih Selamat).
 */
function findRowById(id) {
  if (!id) return { sheet: null, rowNum: -1, rowData: null };
  const sheet = SHEET_DATA;
  const lastRow = sheet.getLastRow();
  
  // Semak jika sheet ada data (baris 1 ialah header)
  if (lastRow < 2) {
    Logger.log("findRowById: Tiada data dalam sheet (LastRow < 2).");
    return { sheet: null, rowNum: -1, rowData: null }; 
  }

  // Dapatkan semua nilai lajur ID
  const idRange = sheet.getRange(2, COL_DATA.IDPermohonan, lastRow - 1, 1).getValues();
  let foundRow = -1;
  const idCarian = id.toString().trim().toUpperCase();

  for (let i = 0; i < idRange.length; i++) {
    const v = (idRange[i][0] || '').toString().trim();
    if (v.toUpperCase() === idCarian) {
      foundRow = i + 2; // (i bermula dari 0, baris data bermula dari 2)
      break;
    }
  }

  if (foundRow === -1) {
    Logger.log(`findRowById: ID "${idCarian}" tidak ditemui.`);
    return { sheet: null, rowNum: -1, rowData: null };
  }

  const rowData = sheet.getRange(foundRow, 1, 1, sheet.getMaxColumns()).getValues()[0];
  return { sheet: sheet, rowNum: foundRow, rowData: rowData };
}


/**
 * Mengisi array baris (newRow) dengan data dari payload.
 */
function fillRowData(newRow, payload) {
    // Medan Borang Biasa
    newRow[COL_DATA.Email - 1] = payload["Email Rasmi Sekolah"];
    newRow[COL_DATA.KodSekolah - 1] = payload["Kod Sekolah"];
    newRow[COL_DATA.NamaSekolah - 1] = payload["Nama Sekolah"];
    newRow[COL_DATA.Daerah - 1] = payload["Daerah"];
    newRow[COL_DATA.Kategori - 1] = payload["Kategori"];
    newRow[COL_DATA.TarikhMula - 1] = payload["Tarikh Mula"];
    newRow[COL_DATA.TarikhAkhir - 1] = payload["Tarikh Akhir"];
    newRow[COL_DATA.TempatLawatan - 1] = payload["Tempat Lawatan"];
    newRow[COL_DATA.AlamatPenginapan - 1] = payload["Alamat Penginapan"];
    newRow[COL_DATA.NoTelPenginapan - 1] = payload["No Tel Penginapan"];
    newRow[COL_DATA.NamaKetuaRombongan - 1] = payload["Nama Ketua Rombongan"];
    newRow[COL_DATA.NoTelKetuaRombongan - 1] = payload["No Tel Ketua Rombongan"];

    // Medan Kewangan (dari sub-objek 'kewangan')
    for (const key in payload.kewangan) {
      if (KEWANGAN_MAP[key]) {
        newRow[KEWANGAN_MAP[key] - 1] = payload.kewangan[key];
      }
    }
}


/**
 * v7.1: Mencipta fail di Google Drive dari data Base64.
 * Menambah ID permohonan pada nama fail untuk elak pertindihan
 */
function createFile(fileData, folderId, idPermohonan) {
  try {
    const folder = DriveApp.getFolderById(folderId);
    const decodedData = Utilities.base64Decode(fileData.data);
    const blob = Utilities.newBlob(decodedData, fileData.mimeType, fileData.filename);
    
    // Cipta nama fail unik
    const namaFailUnik = `${idPermohonan}_${fileData.filename}`;

    // Semak jika fail dengan nama sama wujud
    const files = folder.getFilesByName(namaFailUnik);
    let file;
    if (files.hasNext()) {
      // Ganti kandungan fail sedia ada (berguna untuk Query)
      file = files.next();
      file.setContent(decodedData); 
      Logger.log(`Fail dikemas kini: ${namaFailUnik}`);
    } else {
      // Cipta fail baru
      file = folder.createFile(blob);
      file.setName(namaFailUnik); // Tetapkan nama unik
      Logger.log(`Fail dicipta: ${namaFailUnik}`);
    }
    
    // Tetapkan kebenaran supaya boleh dilihat oleh sesiapa sahaja
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); 
    return file;

  } catch (error) {
    Logger.log(`createFile Error: ${error.stack}`);
    throw new Error(`Gagal muat naik fail: ${fileData.filename}. Pastikan ID Folder (${folderId}) betul dan kebenaran 'Editor' telah ditetapkan.`);
  }
}

/**
 * Menghantar e-mel notifikasi.
 */
function sendNotificationEmail(recipient, subject, body) {
  try {
    if (recipient) {
       GmailApp.sendEmail(recipient, subject, body, {
         name: "Sistem Permohonan Lawatan JPN Pahang"
       });
    }
  } catch (e) {
    Logger.log(`Gagal hantar e-mel notifikasi ke ${recipient}: ${e.message}`);
    // Jangan 'throw error' di sini, biarkan proses utama diteruskan
  }
}

