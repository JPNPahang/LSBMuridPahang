<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LAWATAN MURID — e-SPA JPN Pahang</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui@5/material-ui.min.css">

  <style>
    .sidebar { background:#1f2937; color:#fff; min-height:100vh; }
    .sidebar a { color: #cbd5e1; }
    .sidebar .active { background:#0f172a; color:#fff; }
    .tab-active { background:#2563eb !important; color:#fff !important; } /* bg-blue-600 like */
    #filesModal { z-index: 60; }
    table { table-layout: auto; width: 100%; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="flex">
    <aside class="sidebar w-64 p-6">
      <div class="flex items-center gap-3 mb-6">
        <img id="logoImg" src="IMAGE2.png" alt="Logo JPN" class="w-12 h-12 object-contain">
        <div>
          <div class="text-xl font-bold">LAWATAN MURID</div>
          <div class="text-xs text-gray-300">e-SPA Lawatan — JPN Pahang</div>
        </div>
      </div>

      <nav class="space-y-2">
        <button id="tabIntroBtn" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 nav-tab">Pengenalan</button>
        <button id="tabFormBtn" class="w-full text-left px-4 py-2 rounded nav-tab tab-active">Borang Permohonan</button>
        <button id="tabOfficerBtn" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 nav-tab">Semakan (Pegawai)</button>
        <button id="tabDPBtn" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 nav-tab">Kelulusan (Timbalan)</button>
        <button id="tabQueryResponseBtn" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 nav-tab">Tindak Balas Query</button>
        <button id="tabDownloadsBtn" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 nav-tab">Muat Turun</button>
      </nav>

      <div class="mt-8 text-xs text-gray-400">Versi: 1.0 • Dibangunkan untuk JPN Pahang</div>
    </aside>

    <main class="flex-1 p-8">
      <div class="mb-6">
        <img id="headerImg" src="IMAGE1.png" alt="Header" class="w-full rounded-lg shadow-sm object-cover" style="max-height:140px;">
      </div>

      <section id="introSection" class="bg-white p-6 rounded shadow mb-6 hidden">
        <h2 class="text-2xl font-semibold mb-2">Selamat Datang ke Portal LAWATAN MURID</h2>
        <p class="text-gray-700">Portal ini membolehkan sekolah menghantar permohonan lawatan murid, pegawai menyemak, dan Timbalan membuat kelulusan. Gunakan tab di sebelah kiri untuk navigasi.</p>
      </section>

      <!-- Form (unchanged) -->
      <section id="formSection" class="bg-white p-6 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">Borang Permohonan</h2>
        <form id="permohonanForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm">Kod Sekolah</label><input id="schoolCode" name="schoolCode" class="w-full border p-2 rounded" required /></div>
            <div><label class="block text-sm">Nama Sekolah</label><input id="schoolName" name="schoolName" class="w-full border p-2 rounded" required /></div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm">Email Sekolah</label><input id="schoolEmail" name="schoolEmail" type="email" class="w-full border p-2 rounded" required /></div>
            <div><label class="block text-sm">Kategori</label><select id="category" name="category" class="w-full border p-2 rounded"><option>Menengah</option><option>Rendah</option></select></div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm">Tarikh Mula</label><input id="travelStart" name="travelStart" type="date" class="w-full border p-2 rounded" required /><p class="text-xs text-gray-500 mt-1">Tarikh mesti sekurang-kurangnya 30 hari dari hari ini.</p></div>
            <div><label class="block text-sm">Tarikh Tamat</label><input id="travelEnd" name="travelEnd" type="date" class="w-full border p-2 rounded" required /><p class="text-xs text-gray-500 mt-1">Maksimum 4 hari selepas tarikh mula.</p></div>
          </div>

          <div>
            <label class="block text-sm">Nama Ketua Rombongan</label>
            <div id="leaderList" class="space-y-2 mt-2"></div>
            <button type="button" id="addLeader" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">Tambah Ketua</button>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm">Bilangan Kenderaan</label><input id="vehicleCount" name="vehicleCount" type="number" min="1" class="w-full border p-2 rounded" value="1" required /></div>
            <div><label class="block text-sm">Jumlah Ahli</label><input id="participantCount" name="participantCount" type="number" min="1" class="w-full border p-2 rounded" required /></div>
          </div>

          <div><label class="block text-sm">Tempat Pelancongan</label><input id="placeVisit" name="placeVisit" class="w-full border p-2 rounded" required /></div>
          <div><label class="block text-sm">Alamat Penginapan</label><input id="accommodation" name="accommodation" class="w-full border p-2 rounded" /></div>

          <div>
            <label class="block text-sm font-medium">Muat Naik Fail (PDF) — ikut kategori (5 fail)</label>
            <div class="grid grid-cols-2 gap-3 mt-2">
              <div><label class="text-sm">KERTAS KERJA</label><input type="file" id="file_kertasKerja" name="kertasKerja" accept="application/pdf" /></div>
              <div><label class="text-sm">MAKLUMAT ANGGOTA</label><input type="file" id="file_maklumatAnggota" name="maklumatAnggota" accept="application/pdf" /></div>
              <div><label class="text-sm">PERMIT BAS</label><input type="file" id="file_permitBas" name="permitBas" accept="application/pdf" /></div>
              <div><label class="text-sm">LESEN PEMANDU</label><input type="file" id="file_lesenPemandu" name="lesenPemandu" accept="application/pdf" /></div>
              <div class="col-span-2"><label class="text-sm">INTIPATI TAKLIMAT</label><input type="file" id="file_taklimat" name="taklimat" accept="application/pdf" /></div>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded">Hantar Permohonan</button>
            <div id="submitStatus" class="self-center text-sm text-gray-600"></div>
          </div>
        </form>
      </section>

      <!-- Officer section (updated) -->
      <section id="officerSection" class="hidden bg-white p-6 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Semakan (Pegawai)</h2>

        <!-- Login row (separately) -->
        <div class="mb-4 flex items-center gap-3">
          <button id="loginOfficer" class="px-4 py-2 bg-blue-600 text-white rounded">Log masuk Pegawai</button>
          <span id="officerLoggedAs" class="ml-3 text-sm text-gray-600"></span>

          <!-- Search (kod/nama sekolah) -->
          <div class="ml-auto flex items-center gap-2">
            <input id="searchBox" class="border p-2 rounded text-sm" placeholder="Cari kod sekolah atau nama sekolah..." />
            <button id="searchBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Cari</button>
            <button id="clearSearchBtn" class="px-3 py-1 bg-gray-200 rounded text-sm">Kosong</button>
          </div>
        </div>

        <!-- Filters (without PIC) -->
        <div class="flex gap-3 mb-4 items-center">
          <select id="filterCategory" class="border p-2 rounded">
            <option value="">Semua Kategori</option><option value="Menengah">Menengah</option><option value="Rendah">Rendah</option>
          </select>

          <select id="filterStatus" class="border p-2 rounded">
            <option value="">Semua Status</option>
            <option value="NEW">NEW</option><option value="QUERY">QUERY</option><option value="QUERY_RESPONDED">QUERY_RESPONDED</option>
            <option value="PREAPPROVED">PREAPPROVED</option><option value="READY_FOR_DP">READY_FOR_DP</option><option value="FINAL_APPROVED">FINAL_APPROVED</option>
          </select>

          <button id="applyFilters" class="px-3 py-1 bg-gray-200 rounded">Tapis</button>
          <button id="clearFilters" class="px-3 py-1 bg-gray-100 rounded">Bersihkan</button>
        </div>

        <!-- Three separate tables -->
        <div class="grid grid-cols-1 gap-4">
          <div>
            <h3 class="font-semibold mb-2">Permohonan Baru</h3>
            <div id="tableNew" class="overflow-auto max-h-72 border rounded bg-white p-2"></div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Query</h3>
            <div id="tableQuery" class="overflow-auto max-h-72 border rounded bg-white p-2"></div>
          </div>

          <div>
            <h3 class="font-semibold mb-2">Surat Diluluskan</h3>
            <div id="tableApproved" class="overflow-auto max-h-72 border rounded bg-white p-2"></div>
          </div>
        </div>
      </section>

      <!-- DP, Query Response, Downloads (unchanged) -->
      <section id="dpSection" class="hidden bg-white p-6 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Kelulusan (Timbalan)</h2>
        <div><button id="loginDP" class="px-4 py-2 bg-blue-600 text-white rounded">Log masuk Timbalan</button></div>
        <div id="dpRequestsTable" class="mt-4"></div>
      </section>

      <section id="queryResponseSection" class="hidden bg-white p-6 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Balas Query (Sekolah)</h2>
        <p class="text-gray-700 mb-3">Jika sekolah terima email Query (mengandungi Query ID), gunakan borang di bawah untuk muat naik fail yang diminta tanpa perlu login.</p>
        <div class="space-y-3">
          <div><label class="block text-sm">Query ID</label><input id="respQueryId" class="w-full border p-2 rounded" placeholder="Contoh: QRY-1762..." /></div>
          <div><label class="block text-sm">Email Sekolah (untuk notifikasi)</label><input id="respSchoolEmail" class="w-full border p-2 rounded" placeholder="sekolah@example.com" /></div>
          <div>
            <label class="block text-sm font-medium">Muat Naik Fail (untuk Query)</label>
            <div class="grid grid-cols-2 gap-3 mt-2">
              <div><label class="text-sm">KERTAS KERJA</label><input type="file" id="resp_file_kertasKerja" accept="application/pdf" /></div>
              <div><label class="text-sm">MAKLUMAT ANGGOTA</label><input type="file" id="resp_file_maklumatAnggota" accept="application/pdf" /></div>
              <div><label class="text-sm">PERMIT BAS</label><input type="file" id="resp_file_permitBas" accept="application/pdf" /></div>
              <div><label class="text-sm">LESEN PEMANDU</label><input type="file" id="resp_file_lesenPemandu" accept="application/pdf" /></div>
              <div class="col-span-2"><label class="text-sm">INTIPATI TAKLIMAT</label><input type="file" id="resp_file_taklimat" accept="application/pdf" /></div>
            </div>
          </div>
          <div><button id="sendQueryResponseBtn" class="px-4 py-2 bg-green-600 text-white rounded">Hantar Respon Query</button></div>
        </div>
      </section>

      <section id="downloadsSection" class="hidden bg-white p-6 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Muat Turun</h2>
        <div class="space-x-2">
          <a href="#" class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Bahan 1</a>
          <a href="#" class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Bahan 2</a>
          <a href="#" class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Bahan 3</a>
        </div>
      </section>

    </main>
  </div>

  <div id="filesModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded shadow-lg w-11/12 md:w-2/3 lg:w-1/2 p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="filesModalTitle" class="text-lg font-semibold">Fail Permohonan</h3>
        <button id="filesModalClose" class="text-gray-500 hover:text-gray-800">Tutup ✕</button>
      </div>
      <div id="filesList" class="space-y-3 text-sm max-h-72 overflow-auto"></div>
      <div class="mt-4 text-right"><button id="filesModalClose2" class="px-4 py-2 bg-gray-200 rounded">Tutup</button></div>
    </div>
  </div>

  <div id="loadingModal" class="hidden fixed inset-0 items-center justify-center bg-black bg-opacity-30 z-50">
    <div class="bg-white p-6 rounded shadow text-center"><div class="mb-2">Sila tunggu — proses sedang dijalankan...</div></div>
  </div>

<script>
/* CONFIG */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx_B7hzQrDtlks5fAynamk1s143zUvCxVWEQwfeNC3-BmKCAR9CZ27Sqml7qhIWZN3O/exec';

const $ = id => document.getElementById(id);
function showLoading(){ $('loadingModal').classList.remove('hidden'); $('loadingModal').classList.add('flex'); }
function hideLoading(){ $('loadingModal').classList.add('hidden'); $('loadingModal').classList.remove('flex'); }

/* --- State --- */
let requestsCache = []; // last fetched
let officerSecret = null;
let dpSecret = null;

/* Helpers */
function fmtDateToDisplay(isoOrRaw){
  if (!isoOrRaw) return '';
  const d = new Date(isoOrRaw);
  if (isNaN(d.getTime())) {
    const m = String(isoOrRaw).match(/(\d{4})-(\d{2})-(\d{2})/);
    if (!m) return String(isoOrRaw);
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

/* Date bounds (start + max 4 days) */
(function(){
  const start = $('travelStart'), end = $('travelEnd');
  if (!start||!end) return;
  const setMin = () => {
    const today = new Date(); today.setHours(0,0,0,0);
    const min = new Date(today.getTime() + 30*24*60*60*1000);
    start.min = `${min.getFullYear()}-${String(min.getMonth()+1).padStart(2,'0')}-${String(min.getDate()).padStart(2,'0')}`;
  };
  const updateEndBounds = () => {
    if (!start.value) { end.removeAttribute('max'); return; }
    const s = new Date(start.value);
    const max = new Date(s.getTime() + 4*24*60*60*1000);
    end.min = start.value;
    end.max = `${max.getFullYear()}-${String(max.getMonth()+1).padStart(2,'0')}-${String(max.getDate()).padStart(2,'0')}`;
    if (end.value) {
      const cur = new Date(end.value);
      if (cur < s) end.value = start.value;
      if (cur > max) end.value = end.max;
    }
  };
  setMin(); start.addEventListener('change', updateEndBounds); updateEndBounds();
})();

/* Leaders */
let leaders = [];
function renderLeaders(){ const c=$('leaderList'); c.innerHTML=''; if (leaders.length===0) leaders.push({name:'',phone:''});
  leaders.forEach((l,i)=>{ const div=document.createElement('div'); div.className='flex gap-2 items-center';
    div.innerHTML = `<input class="flex-1 border p-2 rounded leaderName" placeholder="Nama Ketua ${i+1}" data-index="${i}" value="${l.name||''}" />
                     <input class="w-40 border p-2 rounded leaderPhone" placeholder="No. Tel" data-index="${i}" value="${l.phone||''}" />
                     <button type="button" data-index="${i}" class="removeLead bg-red-500 text-white px-2 rounded">X</button>`; c.appendChild(div);
  });
  c.querySelectorAll('.removeLead').forEach(b=>b.addEventListener('click',e=>{leaders.splice(+e.target.dataset.index,1); renderLeaders();}));
  c.querySelectorAll('.leaderName').forEach(i=>i.addEventListener('input',e=>leaders[+e.target.dataset.index].name=e.target.value));
  c.querySelectorAll('.leaderPhone').forEach(i=>i.addEventListener('input',e=>leaders[+e.target.dataset.index].phone=e.target.value));
}
$('addLeader').addEventListener('click',()=>{leaders.push({name:'',phone:''}); renderLeaders();});
renderLeaders();

/* file -> base64 */
async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res({name:file.name,type:file.type||'application/pdf',data:r.result.split(',')[1]}); r.onerror=rej; r.readAsDataURL(file); }); }

/* Submit permohonan */
$('permohonanForm').addEventListener('submit', async function(ev){
  ev.preventDefault(); $('submitBtn').disabled=true;
  const payload = {
    schoolCode:$('schoolCode').value.trim(), schoolName:$('schoolName').value.trim(), schoolEmail:$('schoolEmail').value.trim(),
    category:$('category').value, travelStartDate:$('travelStart').value, travelEndDate:$('travelEnd').value,
    leaderNames: leaders.map(l=>l.name).filter(Boolean), leaderPhones: leaders.map(l=>l.phone).filter(Boolean),
    vehicleCount:$('vehicleCount').value, placeVisit:$('placeVisit').value, accommodation:$('accommodation').value, participantCount:$('participantCount').value
  };
  // validate dates
  const start=new Date(payload.travelStartDate), end=new Date(payload.travelEndDate);
  const today=new Date(); today.setHours(0,0,0,0); const min=new Date(today.getTime()+30*24*60*60*1000);
  if (isNaN(start.getTime())||start<min){ await Swal.fire({icon:'error',title:'Tarikh tidak sah',text:'Tarikh mula mesti sekurang-kurangnya 30 hari.'}); $('submitBtn').disabled=false; return; }
  const maxEnd = new Date(start.getTime()+4*24*60*60*1000);
  if (isNaN(end.getTime())||end<start||end>maxEnd){ await Swal.fire({icon:'error',title:'Tarikh tamat tidak sah',text:`Tarikh tamat mesti antara ${start.toISOString().slice(0,10)} dan ${maxEnd.toISOString().slice(0,10)}.`}); $('submitBtn').disabled=false; return; }

  showLoading();
  try {
    const fileMap = {
      kertasKerja:$('file_kertasKerja').files[0], maklumatAnggota:$('file_maklumatAnggota').files[0],
      permitBas:$('file_permitBas').files[0], lesenPemandu:$('file_lesenPemandu').files[0], taklimat:$('file_taklimat').files[0]
    };
    const filesBase64 = {};
    for (const k in fileMap) if (fileMap[k]) filesBase64[k]=await fileToBase64(fileMap[k]);
    const body = JSON.stringify({type:'new', payload, filesBase64});
    const res = await fetch(GAS_URL, {method:'POST', body});
    const j = await res.json(); hideLoading();
    if (j.ok){ await Swal.fire({icon:'success',title:'Permohonan berjaya dihantar',html:`Nombor rujukan: <b>${j.requestId||''}</b>`}); this.reset(); leaders=[]; renderLeaders(); }
    else await Swal.fire({icon:'error',title:'Gagal',text:j.message||j.error||JSON.stringify(j)});
  } catch (err){ hideLoading(); await Swal.fire({icon:'error',title:'Ralat sambungan',text:err.message||''}); }
  finally{ $('submitBtn').disabled=false; }
});

/* Tabs with active class handling */
function hideAllSections(){ ['introSection','formSection','officerSection','dpSection','queryResponseSection','downloadsSection'].forEach(id=>$(id).classList.add('hidden')); }
function setActiveTab(btnId){
  document.querySelectorAll('.nav-tab').forEach(b=>{ b.classList.remove('tab-active'); b.classList.remove('bg-blue-600'); b.classList.remove('text-white'); });
  const el = $(btnId); if (el) el.classList.add('tab-active');
}
['tabIntroBtn','tabFormBtn','tabOfficerBtn','tabDPBtn','tabQueryResponseBtn','tabDownloadsBtn'].forEach(id=>{
  $(id).addEventListener('click',()=>{ hideAllSections(); const map={tabIntroBtn:'introSection',tabFormBtn:'formSection',tabOfficerBtn:'officerSection',tabDPBtn:'dpSection',tabQueryResponseBtn:'queryResponseSection',tabDownloadsBtn:'downloadsSection'}; $(map[id]).classList.remove('hidden'); setActiveTab(id); });
});

// default
setActiveTab('tabFormBtn');
$('formSection').classList.remove('hidden');

/* Pegawai: login (separate) */
$('loginOfficer').addEventListener('click', async ()=>{
  const { value: pw } = await Swal.fire({ title:'Log masuk Pegawai', input:'password', inputLabel:'Masukkan kata laluan Pegawai', showCancelButton:true, confirmButtonText:'Log masuk' });
  if (!pw) return;
  try {
    showLoading();
    const check = await fetch(GAS_URL + '?action=checkSecret&secret=' + encodeURIComponent(pw));
    const cj = await check.json();
    hideLoading();
    if (cj.ok) {
      officerSecret = pw;
      $('officerLoggedAs').textContent = ' (Disambungkan)';
      await loadRequests();
      Swal.fire({icon:'success',title:'Login Pegawai berjaya'});
    } else Swal.fire({icon:'error',title:'Kata laluan salah'});
  } catch (err){ hideLoading(); Swal.fire({icon:'error',title:'Ralat sambungan',text:err.message||''}); }
});

/* Filters control (no PIC) */
$('applyFilters').addEventListener('click', ()=> renderTablesFromCache());
$('clearFilters').addEventListener('click', ()=>{ $('filterCategory').value=''; $('filterStatus').value=''; $('searchBox').value=''; renderTablesFromCache(); });

/* Search */
$('searchBtn').addEventListener('click', ()=> renderTablesFromCache());
$('clearSearchBtn').addEventListener('click', ()=>{ $('searchBox').value=''; renderTablesFromCache(); });

/* Render helper: table generator */
function makeTable(rows, cols){
  const t = document.createElement('table'); t.className='w-full text-sm';
  const thead = document.createElement('thead'); const trh = document.createElement('tr'); trh.className='bg-gray-100';
  cols.forEach(c=>{ const th=document.createElement('th'); th.className='p-2 text-left'; th.textContent=c; trh.appendChild(th); }); thead.appendChild(trh); t.appendChild(thead);
  const tb=document.createElement('tbody');
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.className='border-b align-top';
    cols.forEach(c=>{ const td=document.createElement('td'); td.className='p-2 align-top'; td.innerHTML = r[c]||''; tr.appendChild(td); });
    tb.appendChild(tr);
  });
  t.appendChild(tb); return t;
}

/* loadRequests -> fetch, cache, then render via renderTablesFromCache */
async function loadRequests(){
  if (!officerSecret) {
    if (requestsCache && requestsCache.length) { renderTablesFromCache(); return; }
    return Swal.fire({icon:'warning',title:'Sila log masuk dahulu.'});
  }
  try {
    showLoading();
    const res = await fetch(GAS_URL + '?action=listRequests&secret=' + encodeURIComponent(officerSecret));
    const j = await res.json();
    hideLoading();
    if (!j.ok) return Swal.fire({icon:'error',title:'Gagal',text:j.message||''});
    const requests = j.requests || [];
    requestsCache = requests; // cache
    renderTablesFromCache();
  } catch (err) { hideLoading(); Swal.fire({icon:'error',title:'Ralat',text:err.message||''}); }
}

/* Utility: extract query history from a request (best-effort) */
function extractQueries(req){
  if (!req) return [];
  if (Array.isArray(req['QueryHistory']) && req['QueryHistory'].length) {
    return req['QueryHistory'].map(q=>({
      id: q.id || q.QueryID || q.queryId || '',
      sentDate: q.sentDate || q.sent_at || q.date || '',
      respondedDate: q.respondedDate || q.responded_at || q.response_date || '',
      note: q.note || q.note_text || q.message || ''
    }));
  }
  const queries = [];
  const txt = String(req['OfficerNote']||req['OfficerNotes']||'');
  if (txt) {
    const re = /QueryID[:\s]*([A-Z0-9\-_]+)/ig;
    let m;
    while ((m = re.exec(txt)) !== null) {
      const id = m[1];
      const slice = txt.slice(Math.max(0,m.index-120), m.index+120);
      const dateMatch = slice.match(/(\d{4}-\d{2}-\d{2})/);
      queries.push({ id, sentDate: dateMatch ? dateMatch[0] : '', respondedDate:'', note: slice.trim() });
    }
  }
  if (req['QueryID'] && !queries.find(q=>q.id===req['QueryID'])) {
    queries.push({ id: req['QueryID'], sentDate: req['QueryDate']||'', respondedDate: req['QueryRespondedDate']||'', note: req['OfficerNote']||'' });
  }
  return queries;
}

/* Render tables from requestsCache applying current filters and search */
function renderTablesFromCache(){
  const requests = requestsCache || [];
  const selCategory = $('filterCategory').value.trim();
  const selStatus = $('filterStatus').value.trim();
  const search = ($('searchBox').value || '').trim().toLowerCase();

  const newRows = [], queryRows = [], approvedRows = [];

  function matchesSearch(req){
    if (!search) return true;
    const code = String(req['School Code'] || req['SchoolCode'] || req['schoolCode'] || '').toLowerCase();
    const name = String(req['School Name'] || req['SchoolName'] || req['schoolName'] || '').toLowerCase();
    return code.includes(search) || name.includes(search);
  }

  requests.forEach(req => {
    if (selCategory && String(req['Category']||req['category']||'') !== selCategory) return;
    if (selStatus && String(req['Status']||'') !== selStatus) return;
    if (!matchesSearch(req)) return;

    const id = req['Request ID'] || '';
    const kodSek = req['School Code'] || req['SchoolCode'] || req['schoolCode'] || '';
    const school = req['School Name'] || req['SchoolName'] || req['schoolName'] || '';

    // derive leader info (best-effort)
    const firstLeader = (() => {
      if (req['LeaderNames'] && Array.isArray(req['LeaderNames']) && req['LeaderNames'][0]) {
        const name = req['LeaderNames'][0];
        const phone = (req['LeaderPhones'] && Array.isArray(req['LeaderPhones']) && req['LeaderPhones'][0]) ? req['LeaderPhones'][0] : '';
        return `${name}${phone?(' — '+phone):''}`;
      }
      if (req['Leaders'] && Array.isArray(req['Leaders']) && req['Leaders'][0]) {
        return `${req['Leaders'][0].name||''}${req['Leaders'][0].phone?(' — '+req['Leaders'][0].phone):''}`;
      }
      if (req['LeaderName'] || req['Leader'] ) {
        const n = req['LeaderName'] || req['Leader'] || '';
        const p = req['LeaderPhone'] || req['LeaderTel'] || '';
        return `${n}${p?(' — '+p):''}`;
      }
      return '';
    })();

    const travelStart = req['Travel Start'] || req['TravelStart'] || req['travelStart'] || '';
    const status = req['Status'] || '';
    const noSurat = req['NoSuratFull'] || (req['Letters'] ? `Surat dijana (${String(req['Letters']).split(/\s*;\s*/).filter(Boolean).length})` : (req['OfficerNote'] && (String(req['OfficerNote']).match(/QueryID:([A-Z0-9\-\_]+)/i) || [])[1] ? `Query: ${(String(req['OfficerNote']).match(/QueryID:([A-Z0-9\-\_]+)/i)||[])[1]}` : '-'));

    // single "Lihat Fail" + other actions
    const actionsGeneric = `<div class="flex gap-2">
        <button data-id="${id}" class="view-files px-2 py-1 border rounded text-xs">Lihat Fail</button>
      </div>`;
    const actionsWithOfficerBtns = `<div class="flex gap-2">
        <button data-id="${id}" class="view-files px-2 py-1 border rounded text-xs">Lihat Fail</button>
        <button data-id="${id}" class="btn-query px-2 py-1 bg-yellow-400 rounded text-xs">Query</button>
        <button data-id="${id}" class="btn-preapprove px-2 py-1 bg-green-600 text-white rounded text-xs">Lulus (Jana Surat)</button>
      </div>`;

    if (String(status).indexOf('QUERY') > -1) {
      const queries = extractQueries(req);
      if (queries.length === 0) {
        const qRow = {
          'Kod Sekolah': kodSek,
          'Nama Sekolah': school,
          'Kategori': req['Category'] || req['category'] || '',
          'Tarikh Query': fmtDateToDisplay(req['QueryDate']||req['Query Sent']||req['QuerySent']||req['QueryCreated']||''),
          'Tarikh Respon': fmtDateToDisplay(req['QueryRespondedDate']||req['QueryResponseDate']||''),
          'Catatan Query': (req['OfficerNote']||req['OfficerNotes']||''),
          'Kod Query': req['QueryID'] || '',
          'Status': status,
          'Surat': noSurat,
          'Tindakan': actionsWithOfficerBtns
        };
        queryRows.push(qRow);
      } else {
        queries.forEach(q=>{
          queryRows.push({
            'Kod Sekolah': kodSek,
            'Nama Sekolah': school,
            'Kategori': req['Category'] || req['category'] || '',
            'Tarikh Query': fmtDateToDisplay(q.sentDate),
            'Tarikh Respon': fmtDateToDisplay(q.respondedDate),
            'Catatan Query': q.note || '',
            'Kod Query': q.id || '',
            'Status': status,
            'Surat': noSurat,
            'Tindakan': actionsWithOfficerBtns
          });
        });
      }
    } else if (String(status).indexOf('FINAL_APPROVED')>-1 || String(status).indexOf('READY_FOR_DP')>-1 || String(status).indexOf('PREAPPROVED')>-1) {
      // approved group -> only Lihat Fail (no query/lulus buttons)
      const letterDate = req['LetterDate'] || req['TarikhSurat'] || req['DateApproved'] || req['ApprovedDate'] || '';
      const letterUrls = String(req['Letters']||'').split(/\s*;\s*/).filter(Boolean);
      const letterLink = letterUrls.length ? `<a href="${letterUrls[0]}" target="_blank" class="text-blue-600 underline">Muat Turun</a>` : '';
      approvedRows.push({
        'Kod Sekolah': kodSek,
        'Nama Sekolah': school,
        'Kategori': req['Category'] || req['category'] || '',
        'Tarikh Surat Lulus': fmtDateToDisplay(letterDate || req['GeneratedDate'] || req['NoSuratDate'] || ''),
        'Link Surat': letterLink,
        'Status': status,
        'Surat': noSurat,
        'Tindakan': actionsGeneric
      });
    } else {
      newRows.push({
        'Kod Sekolah': kodSek,
        'Nama Sekolah': school,
        'Kategori': req['Category'] || req['category'] || '',
        'Tarikh': fmtDateToDisplay(travelStart),
        'Nama Ketua & No Tel': firstLeader || '',
        'Status': status,
        'Surat': noSurat,
        'Tindakan': actionsWithOfficerBtns
      });
    }
  });

  // Sort approvedRows by Tarikh Surat Lulus descending
  approvedRows.sort((a,b)=>{
    const pa = a['Tarikh Surat Lulus'] ? a['Tarikh Surat Lulus'].split('-').reverse().join('-') : '';
    const pb = b['Tarikh Surat Lulus'] ? b['Tarikh Surat Lulus'].split('-').reverse().join('-') : '';
    return pb.localeCompare(pa);
  });

  $('tableNew').innerHTML = '';
  $('tableQuery').innerHTML = '';
  $('tableApproved').innerHTML = '';

  if (newRows.length === 0) {
    $('tableNew').innerHTML = `<p class="p-4 text-gray-500 italic">Tiada permohonan baru sepadan.</p>`;
  } else {
    const colsNew = ['Kod Sekolah','Nama Sekolah','Nama Ketua & No Tel','Kategori','Tarikh','Status','Surat','Tindakan'];
    $('tableNew').appendChild(makeTable(newRows, colsNew));
  }

  if (queryRows.length === 0) {
    $('tableQuery').innerHTML = `<p class="p-4 text-gray-500 italic">Tiada permohonan dalam status query.</p>`;
  } else {
    const colsQuery = ['Kod Sekolah','Nama Sekolah','Kategori','Tarikh Query','Tarikh Respon','Kod Query','Catatan Query','Status','Surat','Tindakan'];
    $('tableQuery').appendChild(makeTable(queryRows, colsQuery));
  }

  if (approvedRows.length === 0) {
    $('tableApproved').innerHTML = `<p class="p-4 text-gray-500 italic">Tiada permohonan yang telah diluluskan.</p>`;
  } else {
    const colsApp = ['Kod Sekolah','Nama Sekolah','Kategori','Tarikh Surat Lulus','Link Surat','Status','Surat','Tindakan'];
    $('tableApproved').appendChild(makeTable(approvedRows, colsApp));
  }

  // Wire up action buttons (view-files, query, preapprove) after render
  document.querySelectorAll('.view-files').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const id = ev.currentTarget.dataset.id;
      const req = (requestsCache || []).find(r => String(r['Request ID']) === String(id));
      if (!req) return Swal.fire({ icon:'error', title:'Tidak jumpa rekod' });
      const files = [
        {label:'KERTAS KERJA', url: req['File_KERTAS_KERJA'] || req['kertasKerjaUrl'] || ''},
        {label:'MAKLUMAT ANGGOTA', url: req['File_MAKLUMAT_ANGGOTA'] || req['maklumatAnggotaUrl'] || ''},
        {label:'PERMIT BAS', url: req['File_PERMIT_BAS'] || req['permitBasUrl'] || ''},
        {label:'LESEN PEMANDU', url: req['File_LESEN_PEMANDU'] || req['lesenPemanduUrl'] || ''},
        {label:'INTIPATI TAKLIMAT', url: req['File_TAKLIMAT'] || req['taklimatUrl'] || ''}
      ];
      const html = files.map(f => f.url ? `<p><strong>${f.label}:</strong> <a href="${f.url}" target="_blank">Buka</a></p>` : `<p><strong>${f.label}:</strong> <em>Tiada fail</em></p>`).join('');
      Swal.fire({ title:'Fail Permohonan', html, width:700, showCloseButton:true, confirmButtonText:'Tutup' });
    });
  });

  document.querySelectorAll('.btn-query').forEach(btn=>{
    btn.addEventListener('click', async ev=>{
      const id = ev.currentTarget.dataset.id;
      const { value: note } = await Swal.fire({ title:'Catatan (kenapa query):', input:'textarea', inputPlaceholder:'Tulis sebab...', showCancelButton:true, confirmButtonText:'Hantar Query' });
      if (!note) return;
      await sendOfficerAction(id,'query', note, 'Menengah');
    });
  });

  document.querySelectorAll('.btn-preapprove').forEach(btn=>{
    btn.addEventListener('click', async ev=>{
      const id = ev.currentTarget.dataset.id;
      const { value: formValues } = await Swal.fire({
        title:'Jana Surat Kelulusan',
        html:`<input id="swal_noJilid" class="swal2-input" placeholder="No Jilid (e.g. 24)">
              <input id="swal_bilSurat" class="swal2-input" placeholder="Bil Surat (angka, e.g. 25)">
              <input id="swal_tarikhSurat" type="date" class="swal2-input">
              <input id="swal_pic" class="swal2-input" placeholder="Nama PIC yang urus (contoh: Ahmad)">`,
        focusConfirm:false, showCancelButton:true, confirmButtonText:'Jana Surat',
        preConfirm:()=>{ const noJ=document.getElementById('swal_noJilid').value; const bil=document.getElementById('swal_bilSurat').value; const tar=document.getElementById('swal_tarikhSurat').value||new Date().toISOString().slice(0,10); const pic=document.getElementById('swal_pic').value||''; if(!noJ||!bil){ Swal.showValidationMessage('Sila isi No Jilid dan Bil Surat'); return false; } return {noJilid:noJ,bilSurat:bil,tarikhSurat:tar,pic}; }
      });
      if (!formValues) return;
      const ok1 = await sendOfficerAction(id,'preapprove','', formValues.pic || 'Menengah');
      if (!ok1) return;
      try {
        const url = GAS_URL + '?action=generateLetters&id=' + encodeURIComponent(id) + '&secret=' + encodeURIComponent(officerSecret) + '&noJilid=' + encodeURIComponent(formValues.noJilid) + '&bilSurat=' + encodeURIComponent(formValues.bilSurat) + '&tarikhSurat=' + encodeURIComponent(formValues.tarikhSurat);
        const r = await fetch(url); const j2 = await r.json();
        if (j2.ok) {
          const display = `JPNP.SPS.100-2/4/5 Jld ${formValues.noJilid} (${formValues.bilSurat})`;
          await Swal.fire({ icon:'success', title:'Surat dijana', html:`No Surat: <b>${display}</b>` });
          if (officerSecret) await loadRequests(); else renderTablesFromCache();
        } else Swal.fire({icon:'error',title:'Gagal jana surat',text:j2.message||JSON.stringify(j2)});
      } catch (err) { Swal.fire({icon:'error',title:'Ralat sambungan',text:err.message||''}); }
    });
  });

}

/* sendOfficerAction */
async function sendOfficerAction(id,type,note='',pic='Menengah'){
  if (!officerSecret) return Swal.fire({icon:'warning',title:'Sila log masuk sebagai Pegawai untuk tindakan ini.'});
  showLoading();
  const url = GAS_URL + '?action=officerAction&id=' + encodeURIComponent(id) + '&type=' + encodeURIComponent(type) + '&note=' + encodeURIComponent(note) + '&pic=' + encodeURIComponent(pic) + '&secret=' + encodeURIComponent(officerSecret);
  try {
    const r = await fetch(url); const j = await r.json();
    hideLoading();
    if (j.ok){ await Swal.fire({icon:'success',title:'Berjaya',text:j.message}); await loadRequests(); return true; }
    else { await Swal.fire({icon:'error',title:'Gagal',text:j.message||JSON.stringify(j)}); return false; }
  } catch (err){ hideLoading(); Swal.fire({icon:'error',title:'Ralat',text:err.message||''}); return false; }
}

/* Timbalan login */
$('loginDP').addEventListener('click', async ()=>{
  const { value: pw } = await Swal.fire({ title:'Log masuk Timbalan', input:'password', showCancelButton:true, confirmButtonText:'Log masuk' });
  if (!pw) return;
  try {
    showLoading();
    const res = await fetch(GAS_URL + '?action=checkSecret&secret=' + encodeURIComponent(pw));
    const j = await res.json(); hideLoading();
    if (j.ok) { dpSecret = pw; Swal.fire({icon:'success',title:'Login Timbalan berjaya'}); loadDpList(); } else Swal.fire({icon:'error',title:'Kata laluan salah'});
  } catch (err){ hideLoading(); Swal.fire({icon:'error',title:'Ralat sambungan',text:err.message||''}); }
});

async function loadDpList(){
  if (!dpSecret) return Swal.fire({icon:'warning',title:'Sila log masuk.'});
  try {
    const res = await fetch(GAS_URL + '?action=listRequests&secret=' + encodeURIComponent(dpSecret));
    const j = await res.json(); if (!j.ok) return Swal.fire({icon:'error',title:'Gagal fetch.'});
    const requests = j.requests.filter(r=> r['Status'] && (String(r['Status']).indexOf('READY_FOR_DP')>-1 || r['Status']==='PREAPPROVED'));
    const div = document.createElement('div');
    if (requests.length === 0) div.innerHTML = `<p class="text-gray-500 italic">Tiada permohonan sedia untuk kelulusan akhir.</p>`;
    requests.forEach(req=>{ const card=document.createElement('div'); card.className='border p-3 mb-2 rounded'; card.innerHTML=`<div class="font-semibold">${req['Request ID']} — ${req['School Name']}</div><div class="text-sm">Status: ${req['Status']}</div>`; const btn=document.createElement('button'); btn.className='mt-2 px-3 py-1 bg-green-600 text-white rounded'; btn.textContent='Diluluskan (Hantar Surat)'; btn.addEventListener('click',async ()=>{ if(!confirm('Sahkan hantar surat kelulusan kepada sekolah?')) return; showLoading(); const r2=await fetch(GAS_URL + '?action=finalApprove&id=' + encodeURIComponent(req['Request ID']) + '&secret=' + encodeURIComponent(dpSecret)); const j2=await r2.json(); hideLoading(); if(j2.ok){ Swal.fire({icon:'success',title:'Emel dihantar.'}); loadDpList(); } else Swal.fire({icon:'error',title:'Gagal',text:j2.message||JSON.stringify(j2)}); }); card.appendChild(btn); div.appendChild(card); });
    $('dpRequestsTable').innerHTML=''; $('dpRequestsTable').appendChild(div);
  } catch (err){ Swal.fire({icon:'error',title:'Ralat',text:err.message||''}); }
}

/* ------------------------------
   Query response (sekolah tanpa login)
   - Enhanced: if GAS returns updatedRequest or files info, merge into requestsCache
   ------------------------------ */
$('sendQueryResponseBtn').addEventListener('click', async ()=>{
  const queryId = $('respQueryId').value && $('respQueryId').value.trim(); if (!queryId) return Swal.fire({icon:'error',title:'Sila masukkan Query ID'});
  showLoading();
  try {
    const fileMap = {
      kertasKerja:$('resp_file_kertasKerja').files[0], maklumatAnggota:$('resp_file_maklumatAnggota').files[0],
      permitBas:$('resp_file_permitBas').files[0], lesenPemandu:$('resp_file_lesenPemandu').files[0], taklimat:$('resp_file_taklimat').files[0]
    };
    const filesBase64={};
    for (const k in fileMap) if (fileMap[k]) filesBase64[k]=await fileToBase64(fileMap[k]);

    const body = JSON.stringify({ type:'queryResponse', payload:{ queryId, schoolEmail: $('respSchoolEmail').value.trim() }, filesBase64 });
    const r = await fetch(GAS_URL, { method:'POST', body });
    const j = await r.json();
    hideLoading();

    if (j.ok){
      // Success — attempt to merge with local cache if server provided updated info
      // Priority 1: server returns updatedRequest (full object)
      // Priority 2: server returns requestId and files (object of urls)
      if (j.updatedRequest && j.updatedRequest['Request ID']){
        const updated = j.updatedRequest;
        // find and replace by Request ID
        const idx = requestsCache.findIndex(x => String(x['Request ID']) === String(updated['Request ID']));
        if (idx > -1) requestsCache[idx] = Object.assign({}, requestsCache[idx], updated);
        else requestsCache.unshift(updated);
        // ensure status becomes QUERY_RESPONDED (or server-provided)
        requestsCache[idx > -1 ? idx : 0]['Status'] = updated['Status'] || 'QUERY_RESPONDED';
        Swal.fire({icon:'success',title:'Respon query diterima',text:'Fail digabungkan dengan permohonan sedia ada.'});
        renderTablesFromCache();
      } else if (j.requestId){
        // server returned requestId and maybe files map
        const rid = j.requestId;
        const files = j.files || {}; // expect keys like kertasKerja => url
        const idx = requestsCache.findIndex(x => String(x['Request ID']) === String(rid));
        if (idx > -1) {
          const target = requestsCache[idx];
          // merge file urls into request object
          Object.keys(files).forEach(k=>{
            // store in same key naming as backend uses if possible
            const mapKey = {
              kertasKerja: 'File_KERTAS_KERJA',
              maklumatAnggota: 'File_MAKLUMAT_ANGGOTA',
              permitBas: 'File_PERMIT_BAS',
              lesenPemandu: 'File_LESEN_PEMANDU',
              taklimat: 'File_TAKLIMAT'
            }[k] || k;
            target[mapKey] = files[k];
          });
          // set status to QUERY_RESPONDED (or server-provided)
          target['Status'] = j.status || 'QUERY_RESPONDED';
          Swal.fire({icon:'success',title:'Respon query diterima',text:'Fail digabungkan dengan permohonan sedia ada.'});
          renderTablesFromCache();
        } else {
          // not in cache: optionally fetch fresh list (only if officer logged in)
          if (officerSecret) {
            await loadRequests();
            Swal.fire({icon:'success',title:'Respon dihantar',text:'Data dikemaskini daripada pelayan.'});
          } else {
            Swal.fire({icon:'success',title:'Respon dihantar',text:'Respon diterima — pegawai akan melihat kemas kini apabila mereka menyegarkan senarai.'});
          }
        }
      } else {
        // No structured data returned. Best-effort: ask to refresh (handled gracefully)
        if (officerSecret) {
          await loadRequests();
          Swal.fire({icon:'success',title:'Respon diterima',text:'Data dikemaskini daripada pelayan.'});
        } else {
          Swal.fire({icon:'success',title:'Respon diterima',text:'Respon diterima — pegawai akan melihat kemas kini apabila mereka menyegarkan senarai.'});
        }
      }

      // clear form
      $('respQueryId').value=''; $('respSchoolEmail').value='';
      ['resp_file_kertasKerja','resp_file_maklumatAnggota','resp_file_permitBas','resp_file_lesenPemandu','resp_file_taklimat'].forEach(id=>{ if($(id)) $(id).value=''; });
    } else {
      Swal.fire({icon:'error',title:'Gagal',text:j.message||JSON.stringify(j)});
    }
  } catch (err){
    hideLoading();
    Swal.fire({icon:'error',title:'Ralat',text:err.message||''});
  }
});


// Initial render: if any cached data exist, render
renderTablesFromCache();

</script>

</body>
</html>
