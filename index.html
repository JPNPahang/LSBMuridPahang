<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Permohonan Lawatan JPNP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display:none; }
    .tab-active { background:#1e40af; color:#fff; }
    .hidden { display:none; }
    .table-scroll { overflow:auto; max-width:100%; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6 max-w-6xl">
    <header class="bg-white shadow rounded p-6 mb-6 text-center">
      <h1 class="text-3xl font-bold text-blue-800">Sistem Permohonan Lawatan Sambil Belajar</h1>
      <p class="text-gray-600">Jabatan Pendidikan Negeri Pahang</p>
    </header>

    <div class="bg-white rounded shadow p-3 mb-6 flex gap-2">
      <button id="btnTabBorang" class="flex-1 p-4 bg-blue-100 font-semibold rounded">Borang Permohonan</button>
      <button id="btnTabDashboard" class="flex-1 p-4 bg-white font-semibold rounded">Dashboard JPN</button>
      <button id="btnTabKelulusan" class="flex-1 p-4 bg-white font-semibold rounded">Kelulusan Pengarah</button>
    </div>

    <!-- BORANG -->
    <div id="contentBorang" class="tab-content bg-white p-6 rounded shadow-lg">
      <div id="dbStatus" class="mb-4 p-3 bg-blue-50 text-blue-800 rounded">Memuatkan pangkalan data sekolah...</div>

      <div class="mb-6">
        <button id="modeBaru" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Permohonan Baru</button>
        <button id="modeQuery" class="px-4 py-2 bg-gray-200 rounded">Hantar Semula (Query)</button>
      </div>

      <div id="querySection" class="hidden p-4 mb-4 bg-blue-50 border rounded">
        <label class="block text-sm font-medium">ID Permohonan</label>
        <input id="queryId" class="mt-1 mb-2 p-2 border rounded w-1/2" />
        <label class="block text-sm font-medium">E-mel</label>
        <input id="queryEmail" class="mt-1 mb-2 p-2 border rounded w-1/2" />
        <button id="btnCariQuery" class="px-4 py-2 bg-blue-600 text-white rounded">Cari Permohonan</button>
        <p id="queryLookupError" class="text-red-600 hidden mt-2"></p>
      </div>

      <form id="borangLawatan" class="space-y-6">
        <input type="hidden" id="isQueryMode" value="false">
        <input type="hidden" id="currentPermohonanId" value="">

        <!-- A -->
        <div>
          <h2 class="text-lg font-semibold">Bahagian A: Maklumat Sekolah</h2>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mt-3">
            <div class="md:col-span-2">
              <label class="block text-sm">Kod Sekolah</label>
              <input id="kodSekolah" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-4">
              <label class="block text-sm">Nama Sekolah</label>
              <input id="namaSekolah" readonly class="mt-1 p-2 bg-gray-100 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label class="block text-sm">Daerah</label>
              <input id="daerahSekolah" readonly class="mt-1 p-2 bg-gray-100 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label class="block text-sm">Kategori</label>
              <input id="kategoriSekolah" readonly class="mt-1 p-2 bg-gray-100 border rounded w-full" />
            </div>
          </div>
        </div>

        <!-- B -->
        <div>
          <h2 class="text-lg font-semibold">Bahagian B: Maklumat Lawatan</h2>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mt-3">
            <div class="md:col-span-3">
              <label>Email Rasmi Sekolah</label>
              <input id="emailSekolah" type="email" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label>Tarikh Mula</label>
              <input id="tarikhMula" type="date" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label>Tarikh Akhir</label>
              <input id="tarikhAkhir" type="date" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label>Nama Ketua Rombongan</label>
              <input id="namaKetuaRombongan" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-3">
              <label>No. Tel Ketua Rombongan</label>
              <input id="noTelKetuaRombongan" class="mt-1 p-2 border rounded w-full" />
            </div>
            <div class="md:col-span-6">
              <label>Tempat Lawatan</label>
              <textarea id="tempatLawatan" class="mt-1 p-2 border rounded w-full"></textarea>
            </div>
            <div class="md:col-span-6">
              <label>Alamat Penginapan</label>
              <textarea id="alamatPenginapan" class="mt-1 p-2 border rounded w-full"></textarea>
            </div>
            <div class="md:col-span-3">
              <label>No. Tel Penginapan</label>
              <input id="noTelPenginapan" class="mt-1 p-2 border rounded w-full" />
            </div>
          </div>
        </div>

        <!-- C muat naik -->
        <div>
          <h2 class="text-lg font-semibold">Bahagian C: Muat Naik Dokumen</h2>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mt-3">
            <div class="md:col-span-3">
              <label>Kertas Kerja (PDF)</label>
              <input id="kertasKerja" type="file" accept=".pdf" class="mt-1" />
            </div>
            <div class="md:col-span-3">
              <label>Maklumat Anggota (PDF)</label>
              <input id="maklumatAnggota" type="file" accept=".pdf" class="mt-1" />
            </div>
            <div class="md:col-span-3">
              <label>Lesen Bas</label>
              <input id="lampiranLesenBas" type="file" accept=".pdf,image/*" class="mt-1" />
            </div>
            <div class="md:col-span-3">
              <label>Lesen Pemandu</label>
              <input id="lampiranLesenPemandu" type="file" accept=".pdf,image/*" class="mt-1" />
            </div>
            <div class="md:col-span-6">
              <label>Intipati Taklimat Keselamatan</label>
              <input id="lampiranTaklimat" type="file" accept=".pdf" class="mt-1" />
            </div>
          </div>
        </div>

        <!-- D kewangan -->
        <div>
          <h2 class="text-lg font-semibold">Bahagian D: Maklumat Kewangan</h2>
          <div class="mt-3 overflow-auto">
            <table class="min-w-full border">
              <thead class="bg-gray-50"><tr>
                <th class="p-2">Sumber</th><th class="p-2">Bil</th><th class="p-2">Kutipan</th><th class="p-2">Jumlah</th>
              </tr></thead>
              <tbody>
                <tr>
                  <td class="p-2">Murid</td>
                  <td class="p-2"><input id="kew_murid_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_murid_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_murid_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr>
                  <td class="p-2">Guru</td>
                  <td class="p-2"><input id="kew_guru_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_guru_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_guru_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr>
                  <td class="p-2">PCG</td>
                  <td class="p-2"><input id="kew_pcg_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_pcg_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_pcg_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr>
                  <td class="p-2">LPBT</td>
                  <td class="p-2"><input id="kew_lpbt_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_lpbt_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_lpbt_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr>
                  <td class="p-2">BMA</td>
                  <td class="p-2"><input id="kew_bma_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_bma_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_bma_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr>
                  <td class="p-2">BPP</td>
                  <td class="p-2"><input id="kew_bpp_bil" type="number" value="0" class="p-1 border rounded w-20"/></td>
                  <td class="p-2"><input id="kew_bpp_kutipan" type="number" value="0" step="0.01" class="p-1 border rounded w-28"/></td>
                  <td class="p-2"><input id="kew_bpp_jumlah" readonly value="0.00" class="p-1 bg-gray-100 border rounded w-32"/></td>
                </tr>
                <tr class="bg-gray-50">
                  <td colspan="3" class="p-2 text-right font-semibold">Jumlah Keseluruhan (RM)</td>
                  <td class="p-2"><input id="kew_jumlah_besar" readonly value="0.00" class="p-1 bg-gray-200 border rounded w-32"/></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="flex justify-end items-center gap-4">
          <div id="loading" class="hidden text-blue-600 font-medium">Menghantar...</div>
          <button id="submitButton" type="submit" class="bg-blue-600 px-5 py-3 text-white rounded">Hantar Permohonan</button>
        </div>

        <div id="borangSuccess" class="hidden mt-4 p-4 bg-green-100 border rounded">
          <strong>Permohonan Berjaya!</strong>
          <div>ID Permohonan: <span id="successId"></span></div>
        </div>
        <div id="borangError" class="hidden mt-4 p-4 bg-red-100 border rounded">
          <strong>Ralat!</strong>
          <div id="errorText"></div>
        </div>
      </form>
    </div>

    <!-- DASHBOARD -->
    <div id="contentDashboard" class="tab-content bg-white p-6 rounded shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Dashboard JPN</h2>
      <p class="mb-4">Masukkan kata laluan untuk muatkan data permohonan.</p>
      <div class="flex gap-2 items-center mb-4">
        <input id="dashboardPass" type="password" placeholder="Kata Laluan" class="p-2 border rounded" />
        <button id="btnLoadData" class="px-4 py-2 bg-blue-600 text-white rounded">Muatkan Data</button>
      </div>
      <div id="dashboardTableWrap" class="table-scroll hidden">
        <table id="dashboardTable" class="min-w-full border">
          <thead class="bg-gray-50"><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="contentKelulusan" class="tab-content bg-white p-6 rounded shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Kelulusan Pengarah</h2>
      <p>Fungsi kelulusan / jana surat akan dipaparkan di sini (boleh diperkembangkan).</p>
    </div>

  </div>

<script>
/* ============ Konfigurasi ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXfvUGbXGZ8X-8OVhGRI4Y8-HJaXUbStnkiSj_DvwnqCuyPAl9eQOgNoZn1iru85lE/exec"; // GANTI dengan exec URL anda jika lain
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSRZ4X7exDV-Bu9BSV0IjGswnQjpoYBgXBT-llAz2Iwr4z8fGWV0VX-DWzzYAEMmq-CWGqlXDayGYED/pub?gid=0&single=true&output=csv";
const PASSWORD = "12345";

/* ============ Tab handling ============ */
function showTab(name) {
  document.getElementById('contentBorang').style.display = 'none';
  document.getElementById('contentDashboard').style.display = 'none';
  document.getElementById('contentKelulusan').style.display = 'none';
  document.getElementById('btnTabBorang').classList.remove('tab-active');
  document.getElementById('btnTabDashboard').classList.remove('tab-active');
  document.getElementById('btnTabKelulusan').classList.remove('tab-active');

  if (name === 'borang') {
    document.getElementById('contentBorang').style.display = 'block';
    document.getElementById('btnTabBorang').classList.add('tab-active');
  } else if (name === 'dashboard') {
    document.getElementById('contentDashboard').style.display = 'block';
    document.getElementById('btnTabDashboard').classList.add('tab-active');
  } else {
    document.getElementById('contentKelulusan').style.display = 'block';
    document.getElementById('btnTabKelulusan').classList.add('tab-active');
  }
}

/* ============ Init ============ */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnTabBorang').addEventListener('click', ()=> showTab('borang'));
  document.getElementById('btnTabDashboard').addEventListener('click', ()=> showTab('dashboard'));
  document.getElementById('btnTabKelulusan').addEventListener('click', ()=> showTab('kelulusan'));
  showTab('borang');

  document.getElementById('modeBaru').addEventListener('click', ()=> { document.getElementById('isQueryMode').value='false'; document.getElementById('querySection').classList.add('hidden'); document.getElementById('borangLawatan').classList.remove('hidden'); });
  document.getElementById('modeQuery').addEventListener('click', ()=> { document.getElementById('isQueryMode').value='true'; document.getElementById('querySection').classList.remove('hidden'); document.getElementById('borangLawatan').classList.add('hidden'); });

  document.getElementById('btnCariQuery').addEventListener('click', cariQuery);
  document.getElementById('btnLoadData').addEventListener('click', loadDashboardData);

  // load CSV
  loadSchoolCSV();

  // kod sekolah lookup
  document.getElementById('kodSekolah').addEventListener('blur', lookupSekolahFromCsv);

  // auto calculate kewangan
  ['murid','guru','pcg','lpbt','bma','bpp'].forEach(id => {
    const bil = document.getElementById(`kew_${id}_bil`);
    const kutipan = document.getElementById(`kew_${id}_kutipan`);
    if (bil) bil.addEventListener('input', kiraJumlah);
    if (kutipan) kutipan.addEventListener('input', kiraJumlah);
  });

  // attach form submit
  document.getElementById('borangLawatan').addEventListener('submit', handleFormSubmit);
});

/* ============ CSV sekolah ============ */
let SCHOOL_DB = null;
async function loadSchoolCSV() {
  const el = document.getElementById('dbStatus');
  try {
    const r = await fetch(CSV_URL);
    if (!r.ok) throw new Error('Gagal muat CSV: ' + r.status);
    const txt = await r.text();
    const lines = txt.trim().split(/\r?\n/);
    const header = lines.shift().split(',');
    const map = {}; header.forEach((h,i)=>map[h.trim()]=i);
    const db = {};
    lines.forEach(line=>{
      const cols = line.split(',');
      const kode = (cols[map['KOD_SEKOLAH']]||'').trim();
      if (kode) {
        db[kode.toUpperCase()] = {
          nama: cols[map['NAMA_SEKOLAH']] || '',
          daerah: cols[map['DAERAH']] || '',
          kategori: cols[map['KATEGORI']] || ''
        };
      }
    });
    SCHOOL_DB = db;
    el.innerHTML = `<strong>STATUS:</strong> Pangkalan data sekolah sedia (${Object.keys(db).length} rekod).`;
    el.classList.remove('bg-blue-50'); el.classList.add('bg-green-100');
  } catch (e) {
    el.innerHTML = `<strong>RALAT:</strong> Gagal muatkan CSV. ${e.message}`;
    el.classList.remove('bg-blue-50'); el.classList.add('bg-red-100');
    console.error(e);
  }
}

function lookupSekolahFromCsv() {
  if (!SCHOOL_DB) return;
  const k = document.getElementById('kodSekolah').value.trim().toUpperCase();
  if (!k) return;
  const d = SCHOOL_DB[k];
  if (d) {
    document.getElementById('namaSekolah').value = d.nama;
    document.getElementById('daerahSekolah').value = d.daerah;
    document.getElementById('kategoriSekolah').value = d.kategori;
  } else {
    document.getElementById('namaSekolah').value = '';
    document.getElementById('daerahSekolah').value = '';
    document.getElementById('kategoriSekolah').value = '';
  }
}

/* ============ Kewangan ============ */
function kiraJumlah() {
  const ids = ['murid','guru','pcg','lpbt','bma','bpp'];
  let total = 0;
  ids.forEach(id => {
    const bil = parseFloat(document.getElementById(`kew_${id}_bil`).value) || 0;
    const kutipan = parseFloat(document.getElementById(`kew_${id}_kutipan`).value) || 0;
    const jumlah = bil * kutipan;
    const elJumlah = document.getElementById(`kew_${id}_jumlah`);
    if (elJumlah) elJumlah.value = jumlah.toFixed(2);
    total += jumlah;
  });
  const elTotal = document.getElementById('kew_jumlah_besar');
  if (elTotal) elTotal.value = total.toFixed(2);
}

/* ============ Helper: baca fail jadi base64 ============ */
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = e=> reject(e);
    r.readAsDataURL(file);
  });
}

/* ============ Handle form submit ============ */
async function handleFormSubmit(e) {
  e.preventDefault();
  const loading = document.getElementById('loading');
  const successBox = document.getElementById('borangSuccess');
  const errorBox = document.getElementById('borangError');
  const errorText = document.getElementById('errorText');
  const successIdEl = document.getElementById('successId');

  function setLoading(on) { if (on) { loading.classList.remove('hidden'); document.getElementById('submitButton').disabled = true; } else { loading.classList.add('hidden'); document.getElementById('submitButton').disabled = false; } }
  function showError(msg){ errorText.textContent = msg; errorBox.classList.remove('hidden'); successBox.classList.add('hidden'); }
  function showSuccess(id){ successIdEl.textContent = id; successBox.classList.remove('hidden'); errorBox.classList.add('hidden'); setTimeout(()=>{ document.getElementById('borangLawatan').reset(); successBox.classList.add('hidden'); },5000); }

  try {
    setLoading(true);
    // Basic validation
    const kode = document.getElementById('kodSekolah').value.trim();
    const email = document.getElementById('emailSekolah').value.trim();
    if (!kode || !email) throw new Error('Sila lengkapkan Kod Sekolah dan E-mel rasmi sekolah.');

    // Build payload
    const payload = {
      action: document.getElementById('isQueryMode').value === 'true' ? 'resubmitPermohonan' : 'submitPermohonan',
      "Email Rasmi Sekolah": email,
      "Kod Sekolah": kode,
      "Nama Sekolah": document.getElementById('namaSekolah').value || '',
      "Daerah": document.getElementById('daerahSekolah').value || '',
      "Kategori": document.getElementById('kategoriSekolah').value || '',
      "Tarikh Mula": document.getElementById('tarikhMula').value || '',
      "Tarikh Akhir": document.getElementById('tarikhAkhir').value || '',
      "Tempat Lawatan": document.getElementById('tempatLawatan').value || '',
      "Alamat Penginapan": document.getElementById('alamatPenginapan').value || '',
      "No Tel Penginapan": document.getElementById('noTelPenginapan').value || '',
      "Nama Ketua Rombongan": document.getElementById('namaKetuaRombongan').value || '',
      "No Tel Ketua Rombongan": document.getElementById('noTelKetuaRombongan').value || ''
    };

    if (payload.action === 'resubmitPermohonan') {
      payload.idPermohonan = document.getElementById('currentPermohonanId').value;
      if (!payload.idPermohonan) throw new Error('ID permohonan diperlukan untuk resubmit.');
    }

    // kewangan object
    payload.kewangan = {
      "Kewangan_Murid_Bil": document.getElementById('kew_murid_bil').value || 0,
      "Kewangan_Murid_Kutipan": document.getElementById('kew_murid_kutipan').value || 0,
      "Kewangan_Murid_Jumlah": document.getElementById('kew_murid_jumlah').value || 0,
      "Kewangan_Guru_Bil": document.getElementById('kew_guru_bil').value || 0,
      "Kewangan_Guru_Kutipan": document.getElementById('kew_guru_kutipan').value || 0,
      "Kewangan_Guru_Jumlah": document.getElementById('kew_guru_jumlah').value || 0,
      "Kewangan_AkaunSek_PCG_Bil": document.getElementById('kew_pcg_bil').value || 0,
      "Kewangan_AkaunSek_PCG_Kutipan": document.getElementById('kew_pcg_kutipan').value || 0,
      "Kewangan_AkaunSek_PCG_Jumlah": document.getElementById('kew_pcg_jumlah').value || 0,
      "Kewangan_AkaunSek_LPBT_Bil": document.getElementById('kew_lpbt_bil').value || 0,
      "Kewangan_AkaunSek_LPBT_Kutipan": document.getElementById('kew_lpbt_kutipan').value || 0,
      "Kewangan_AkaunSek_LPBT_Jumlah": document.getElementById('kew_lpbt_jumlah').value || 0,
      "Kewangan_Asrama_BMA_Bil": document.getElementById('kew_bma_bil').value || 0,
      "Kewangan_Asrama_BMA_Kutipan": document.getElementById('kew_bma_kutipan').value || 0,
      "Kewangan_Asrama_BMA_Jumlah": document.getElementById('kew_bma_jumlah').value || 0,
      "Kewangan_Asrama_BPP_Bil": document.getElementById('kew_bpp_bil').value || 0,
      "Kewangan_Asrama_BPP_Kutipan": document.getElementById('kew_bpp_kutipan').value || 0,
      "Kewangan_Asrama_BPP_Jumlah": document.getElementById('kew_bpp_jumlah').value || 0,
      "Kewangan_Jumlah_Besar": document.getElementById('kew_jumlah_besar').value || 0
    };

    // files
    const filesMap = {
      kertasKerja: document.getElementById('kertasKerja'),
      maklumatAnggota: document.getElementById('maklumatAnggota'),
      lampiranLesenBas: document.getElementById('lampiranLesenBas'),
      lampiranLesenPemandu: document.getElementById('lampiranLesenPemandu'),
      lampiranTaklimat: document.getElementById('lampiranTaklimat')
    };
    payload.files = {};
    for (const key in filesMap) {
      const input = filesMap[key];
      if (input && input.files && input.files[0]) {
        const f = input.files[0];
        const base64 = await readFileAsBase64(f); // data:xxx;base64,AAA...
        payload.files[key] = {
          filename: f.name,
          mimeType: f.type || 'application/octet-stream',
          data: base64.split(',')[1]
        };
      }
    }

    console.log("PAYLOAD:", payload);

    // Hantar sebagai text/plain untuk kurangkan preflight
    const resp = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });

    const txt = await resp.text();
    let json;
    try { json = JSON.parse(txt); } catch (e) { throw new Error("Invalid JSON from server: " + txt); }

    if (json.status && (json.status === 'success')) {
      showSuccess(json.idPermohonan || json.idPermohonan || json.idPermohonan || json.idPermohonan || json.idPermohonan || json.idPermohonan);
    } else {
      throw new Error(json.message || "Ralat dari server.");
    }

  } catch (err) {
    console.error("handleFormSubmit Error:", err);
    showError("Gagal hantar: " + (err.message || err));
  } finally {
    setTimeout(()=>{ document.getElementById('submitButton').disabled = false; }, 1000);
    document.getElementById('loading').classList.add('hidden');
  }
}

/* ============ Cari Query ============ */
async function cariQuery() {
  const id = document.getElementById('queryId').value.trim();
  const email = document.getElementById('queryEmail').value.trim();
  const errEl = document.getElementById('queryLookupError');
  errEl.classList.add('hidden'); errEl.textContent = '';
  if (!id || !email) { errEl.textContent = 'Sila masukkan ID dan e-mel.'; errEl.classList.remove('hidden'); return; }
  try {
    const r = await fetch(`${SCRIPT_URL}?action=getPermohonanForEdit&id=${encodeURIComponent(id)}&email=${encodeURIComponent(email)}`);
    const txt = await r.text(); const data = JSON.parse(txt);
    if (data.status === 'success') {
      fillBorangWithData(data.data);
      document.getElementById('isQueryMode').value = 'true';
      document.getElementById('currentPermohonanId').value = id;
      document.getElementById('querySection').classList.add('hidden');
      document.getElementById('borangLawatan').classList.remove('hidden');
    } else {
      errEl.textContent = data.message || 'Permohonan tidak ditemui.';
      errEl.classList.remove('hidden');
    }
  } catch (e) {
    console.error('cariQuery', e);
    errEl.textContent = 'Ralat sambungan: ' + e.message;
    errEl.classList.remove('hidden');
  }
}

/* ============ Fill borang from record ============ */
function fillBorangWithData(data) {
  document.getElementById('kodSekolah').value = data['Kod Sekolah'] || data['KOD_SEKOLAH'] || '';
  document.getElementById('namaSekolah').value = data['Nama Sekolah'] || data['NAMA_SEKOLAH'] || '';
  document.getElementById('daerahSekolah').value = data['Daerah'] || data['DAERAH'] || '';
  document.getElementById('kategoriSekolah').value = data['Kategori'] || data['KATEGORI'] || '';
  document.getElementById('emailSekolah').value = data['Email Rasmi Sekolah'] || data['Email'] || '';
  document.getElementById('tarikhMula').value = data['Tarikh Mula'] ? data['Tarikh Mula'].split('T')[0] : (data['Tarikh Mula'] || '');
  document.getElementById('tarikhAkhir').value = data['Tarikh Akhir'] ? data['Tarikh Akhir'].split('T')[0] : (data['Tarikh Akhir'] || '');
  document.getElementById('namaKetuaRombongan').value = data['Nama Ketua Rombongan'] || '';
  document.getElementById('noTelKetuaRombongan').value = data['No Tel Ketua Rombongan'] || '';
  document.getElementById('tempatLawatan').value = data['Tempat Lawatan'] || '';
  document.getElementById('alamatPenginapan').value = data['Alamat Penginapan'] || '';
  document.getElementById('noTelPenginapan').value = data['No Tel Penginapan'] || '';

  // kewangan mapping
  const map = {
    'kew_murid_bil':'Kewangan_Murid_Bil','kew_murid_kutipan':'Kewangan_Murid_Kutipan','kew_murid_jumlah':'Kewangan_Murid_Jumlah',
    'kew_guru_bil':'Kewangan_Guru_Bil','kew_guru_kutipan':'Kewangan_Guru_Kutipan','kew_guru_jumlah':'Kewangan_Guru_Jumlah',
    'kew_pcg_bil':'Kewangan_AkaunSek_PCG_Bil','kew_pcg_kutipan':'Kewangan_AkaunSek_PCG_Kutipan','kew_pcg_jumlah':'Kewangan_AkaunSek_PCG_Jumlah',
    'kew_lpbt_bil':'Kewangan_AkaunSek_LPBT_Bil','kew_lpbt_kutipan':'Kewangan_AkaunSek_LPBT_Kutipan','kew_lpbt_jumlah':'Kewangan_AkaunSek_LPBT_Jumlah',
    'kew_bma_bil':'Kewangan_Asrama_BMA_Bil','kew_bma_kutipan':'Kewangan_Asrama_BMA_Kutipan','kew_bma_jumlah':'Kewangan_Asrama_BMA_Jumlah',
    'kew_bpp_bil':'Kewangan_Asrama_BPP_Bil','kew_bpp_kutipan':'Kewangan_Asrama_BPP_Kutipan','kew_bpp_jumlah':'Kewangan_Asrama_BPP_Jumlah'
  };
  for (const htmlId in map) {
    const v = data[ map[htmlId] ] || '';
    const el = document.getElementById(htmlId);
    if (el) el.value = v;
  }
  document.getElementById('kew_jumlah_besar').value = data['Kewangan_Jumlah_Besar'] || '';
  kiraJumlah();
}

/* ============ Dashboard: load data (requires token) ============ */
async function loadDashboardData() {
  const token = document.getElementById('dashboardPass').value;
  if (!token) { alert('Sila masukkan kata laluan.'); return; }
  try {
    const r = await fetch(`${SCRIPT_URL}?action=getData&token=${encodeURIComponent(token)}`);
    const txt = await r.text(); const data = JSON.parse(txt);
    if (data.status === 'success') populateDashboardTable(data.data || []);
    else alert('Gagal muat data: ' + (data.message || 'Unauthorized'));
  } catch (e) { console.error('loadDashboardData', e); alert('Ralat sambungan: '+e.message); }
}

function populateDashboardTable(rows) {
  const tbl = document.getElementById('dashboardTable');
  const thead = tbl.querySelector('thead tr');
  const tbody = tbl.querySelector('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';
  if (!rows || !rows.length) { thead.innerHTML = '<th class="p-2">Tiada data</th>'; document.getElementById('dashboardTableWrap').classList.remove('hidden'); return; }
  const keys = Object.keys(rows[0]);
  keys.forEach(k => { const th = document.createElement('th'); th.className='p-2 border'; th.textContent = k; thead.appendChild(th); });
  const thAct = document.createElement('th'); thAct.className='p-2 border'; thAct.textContent='Tindakan'; thead.appendChild(thAct);

  rows.forEach(r => {
    const tr = document.createElement('tr');
    keys.forEach(k => { const td = document.createElement('td'); td.className='p-2 border'; td.textContent = r[k] || ''; tr.appendChild(td); });
    const tdAct = document.createElement('td'); tdAct.className='p-2 border';
    const btnView = document.createElement('button'); btnView.className='px-2 py-1 bg-gray-200 rounded mr-2'; btnView.textContent='Lihat'; btnView.onclick = ()=> { showTab('borang'); fillBorangWithData(r); };
    const btnQuery = document.createElement('button'); btnQuery.className='px-2 py-1 bg-yellow-300 rounded mr-2'; btnQuery.textContent='Query'; btnQuery.onclick = ()=> { startQuery(r); };
    const btnLulus = document.createElement('button'); btnLulus.className='px-2 py-1 bg-green-500 text-white rounded'; btnLulus.textContent='Lulus JPN'; btnLulus.onclick = ()=> approveJpn(r);
    tdAct.appendChild(btnView); tdAct.appendChild(btnQuery); tdAct.appendChild(btnLulus);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
  document.getElementById('dashboardTableWrap').classList.remove('hidden');
}

function startQuery(record) {
  const id = record['ID Permohonan'] || record['IDPermohonan'] || record['ID Permohonan'];
  showTab('borang'); document.getElementById('isQueryMode').value='true'; document.getElementById('currentPermohonanId').value = id; fillBorangWithData(record);
  alert('Sila buat pembetulan dan tekan Hantar Semula (mod Query).');
}

async function approveJpn(record) {
  if (!confirm('Sahkan Lulus JPN untuk permohonan ini?')) return;
  const id = record['ID Permohonan'] || record['IDPermohonan'] || record['ID Permohonan'];
  try {
    const body = { action:'updateStatus', token:PASSWORD, idPermohonan:id, status:'Lulus JPN', catatan:'' };
    const r = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body) });
    const txt = await r.text(); const resp = JSON.parse(txt);
    if (resp.status === 'success') { alert('Status dikemaskini: Lulus JPN'); loadDashboardData(); } else alert('Gagal update: '+(resp.message||''));
  } catch (e) { console.error('approveJpn', e); alert('Ralat: '+e.message); }
}

</script>
</body>
</html>
