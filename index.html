<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LAWATAN MURID ‚Äî e-SPA JPN Pahang</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- SweetAlert2 for nice modals -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    /* Sidebar fixed layout */
    .sidebar { width: 260px; min-height: 100vh; position: fixed; left:0; top:0; background:#16222A; color:white; padding:28px 18px; }
    .content { margin-left:260px; padding:28px; background:#f3f4f6; min-height:100vh; }
    .nav-btn { display:flex; align-items:center; gap:.75rem; padding:10px 14px; border-radius:8px; cursor:pointer; color:#cfe8ff; }
    .nav-btn.active { background:#1f6feb; color:white; box-shadow:0 6px 18px rgba(31,111,235,0.12); }
    .card { background:white; border-radius:12px; padding:20px; box-shadow:0 6px 18px rgba(7,7,7,0.06); }
    .small-muted { font-size:.9rem; color:#6b7280; }
    /* responsive */
    @media (max-width:900px){ .sidebar{position:static;width:100%;} .content{margin-left:0;} }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="mb-6">
      <!-- imej2: logo JPN kecil (ganti URL) -->
      <img id="logoJPN" src="IMAGE2_URL" alt="Logo JPN" style="max-width:120px; display:block; margin-bottom:14px;">
      <h2 style="font-size:20px; font-weight:700; margin-bottom:2px;">LAWATAN MURID</h2>
      <div class="small-muted">e-SPA Lawatan ‚Äî JPN Pahang</div>
    </div>

    <nav class="mt-6 space-y-2">
      <div id="navIntro" class="nav-btn active">üìò Pengenalan</div>
      <div id="navForm" class="nav-btn">üìù Borang Permohonan</div>
      <div id="navOfficer" class="nav-btn">üîé Semakan (Pegawai)</div>
      <div id="navDP" class="nav-btn">‚úÖ Kelulusan (Timbalan)</div>
      <div id="navRespond" class="nav-btn">üì§ Tindak Balas Query</div>
      <div id="navDownloads" class="nav-btn">‚¨áÔ∏è Muat Turun</div>
    </nav>

    <div style="position:absolute; bottom:28px; left:18px; right:18px;" class="small-muted">
      Versi: 1.0 ‚Ä¢ Dibangunkan untuk JPN Pahang
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <!-- header image (image1) -->
    <div style="margin-bottom:18px;">
      <img id="headerImage" src="IMAGE1_URL" alt="Header" style="width:100%; max-height:160px; object-fit:cover; border-radius:12px;">
    </div>

    <!-- PENGENALAN -->
    <section id="sectionIntro" class="card">
      <h1 class="text-2xl font-bold mb-2">Selamat Datang ke Portal LAWATAN MURID</h1>
      <p class="small-muted mb-4">Portal ini memudahkan sekolah menghantar permohonan lawatan, pegawai menilai, dan Timbalan Pengarah meluluskan serta menjana surat kelulusan.</p>

      <h3 class="font-semibold">Apa sistem ini lakukan</h3>
      <ul class="list-disc pl-6 mt-2 small-muted">
        <li>Terima permohonan lawatan (borang + 5 fail PDF).</li>
        <li>Pegawai boleh semak, buat query (minta fail tambahan) atau pra-lulus.</li>
        <li>Timbalan boleh hantar surat kelulusan (PDF dijana automatik).</li>
        <li>Sekolah boleh jawab query menggunakan <strong>Tindak Balas Query</strong> ‚Äî masukkan Request ID & Query ID dari e-mel dan muat naik fail.</li>
      </ul>
    </section>

    <!-- BORANG PERMOHONAN -->
    <section id="sectionForm" class="card hidden mt-6">
      <h2 class="text-xl font-semibold mb-2">Borang Permohonan</h2>
      <form id="permohonanForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm">Kod Sekolah</label>
            <input id="schoolCode" class="w-full border p-2 rounded" required />
          </div>
          <div>
            <label class="text-sm">Nama Sekolah</label>
            <input id="schoolName" class="w-full border p-2 rounded" required />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm">Email Sekolah</label>
            <input id="schoolEmail" type="email" class="w-full border p-2 rounded" required />
          </div>
          <div>
            <label class="text-sm">Kategori</label>
            <select id="category" class="w-full border p-2 rounded">
              <option>Menengah</option>
              <option>Rendah</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm">Tarikh Mula</label>
            <input id="travelStart" type="date" class="w-full border p-2 rounded" required />
            <div class="small-muted mt-1">Tarikh mesti sekurang-kurangnya 30 hari dari hari ini.</div>
          </div>
          <div>
            <label class="text-sm">Tarikh Tamat</label>
            <input id="travelEnd" type="date" class="w-full border p-2 rounded" required />
          </div>
        </div>

        <div>
          <label class="text-sm">Nama Ketua Rombongan & No. Tel (boleh tambah lebih dari satu)</label>
          <div id="leaderList" class="space-y-2 mt-2"></div>
          <button type="button" id="addLeader" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">Tambah Ketua</button>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm">Bilangan Kenderaan</label>
            <input id="vehicleCount" type="number" min="1" value="1" class="w-full border p-2 rounded" required />
          </div>
          <div>
            <label class="text-sm">Jumlah Ahli</label>
            <input id="participantCount" type="number" min="1" class="w-full border p-2 rounded" required />
          </div>
        </div>

        <div>
          <label class="text-sm">Tempat Pelancongan</label>
          <input id="placeVisit" class="w-full border p-2 rounded" required />
        </div>

        <div>
          <label class="text-sm">Alamat Penginapan</label>
          <input id="accommodation" class="w-full border p-2 rounded" />
        </div>

        <div>
          <label class="text-sm font-medium">Muat Naik Fail (PDF) ‚Äî ikut kategori (5 fail)</label>
          <div class="grid grid-cols-2 gap-3 mt-2">
            <div><label class="text-sm">KERTAS KERJA</label><input type="file" id="file_kertasKerja" accept="application/pdf" /></div>
            <div><label class="text-sm">MAKLUMAT ANGGOTA</label><input type="file" id="file_maklumatAnggota" accept="application/pdf" /></div>
            <div><label class="text-sm">PERMIT BAS</label><input type="file" id="file_permitBas" accept="application/pdf" /></div>
            <div><label class="text-sm">LESEN PEMANDU</label><input type="file" id="file_lesenPemandu" accept="application/pdf" /></div>
            <div><label class="text-sm">INTIPATI TAKLIMAT</label><input type="file" id="file_taklimat" accept="application/pdf" /></div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded">Hantar Permohonan</button>
          <div id="submitStatus" class="small-muted"></div>
        </div>
      </form>
    </section>

    <!-- SEMAKAN (Pegawai) -->
    <section id="sectionOfficer" class="card hidden mt-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Semakan (Pegawai)</h2>
        <div>
          <button id="loginOfficer" class="px-3 py-1 bg-blue-600 text-white rounded">Log masuk Pegawai</button>
          <select id="filterCategory" class="border p-2 rounded ml-2">
            <option value="">Semua Kategori</option>
            <option value="Menengah">Menengah</option>
            <option value="Rendah">Rendah</option>
          </select>
        </div>
      </div>
      <div id="requestsTable" class="overflow-auto"></div>
    </section>

    <!-- KELULUSAN (Timbalan) -->
    <section id="sectionDP" class="card hidden mt-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Kelulusan (Timbalan)</h2>
        <div><button id="loginDP" class="px-3 py-1 bg-blue-600 text-white rounded">Log masuk Timbalan</button></div>
      </div>
      <div id="dpRequestsTable"></div>
    </section>

    <!-- TINDAK BALAS QUERY (SEKOLAH) -->
    <section id="sectionRespond" class="card hidden mt-6">
      <h2 class="text-xl font-semibold mb-2">Tindak Balas Query</h2>
      <p class="small-muted">Masukkan Request ID dan Query ID (dari e-mel) untuk muat naik fail jawapan.</p>
      <form id="respondForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm">Request ID</label><input id="respRequestId" class="w-full border p-2 rounded" required /></div>
          <div><label class="text-sm">Query ID</label><input id="respQueryId" class="w-full border p-2 rounded" required /></div>
        </div>

        <div>
          <label class="text-sm font-medium">Muat Naik Fail (PDF)</label>
          <div class="grid grid-cols-2 gap-3 mt-2">
            <div><label class="text-sm">KERTAS KERJA</label><input type="file" id="resp_file_kertasKerja" accept="application/pdf" /></div>
            <div><label class="text-sm">MAKLUMAT ANGGOTA</label><input type="file" id="resp_file_maklumatAnggota" accept="application/pdf" /></div>
            <div><label class="text-sm">PERMIT BAS</label><input type="file" id="resp_file_permitBas" accept="application/pdf" /></div>
            <div><label class="text-sm">LESEN PEMANDU</label><input type="file" id="resp_file_lesenPemandu" accept="application/pdf" /></div>
            <div><label class="text-sm">INTIPATI TAKLIMAT</label><input type="file" id="resp_file_taklimat" accept="application/pdf" /></div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button id="respSubmitBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Hantar Tindak Balas Query</button>
          <div id="respStatus" class="small-muted"></div>
        </div>
      </form>
    </section>

    <!-- MUAT TURUN -->
    <section id="sectionDownloads" class="card hidden mt-6">
      <h2 class="text-xl font-semibold mb-2">Muat Turun</h2>
      <p class="small-muted">Butang muat turun / bahan rujukan. Tampal URL anda di dalam kod (rujuk bahagian DOWNLOAD_LINKS di bawah).</p>
      <div id="downloadsList" class="space-y-2 mt-4">
        <!-- Buttons akan dijana dari array DOWNLOAD_LINKS -->
      </div>
    </section>
  </main>

  <!-- LOADING OVERLAY -->
  <div id="loadingModal" class="fixed inset-0 hidden items-center justify-center" style="background:rgba(0,0,0,0.35); z-index:50;">
    <div class="bg-white p-6 rounded shadow">Sila tunggu ‚Äî proses sedang dijalankan...</div>
  </div>

<script>
/* ========== CONFIG ========== */
/* GANTI dengan URL web app anda (Apps Script deployed URL) */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx_B7hzQrDtlks5fAynamk1s143zUvCxVWEQwfeNC3-BmKCAR9CZ27Sqml7qhIWZN3O/exec';

/* DOWNLOAD BUTTONS (sesuaikan URL anda di sini) */
const DOWNLOAD_LINKS = [
  { label: 'Manual Pengguna (PDF)', url: 'https://example.com/manual.pdf' },
  { label: 'Template Surat (DOCX)', url: 'https://example.com/template.docx' },
  { label: 'SOP JPN', url: 'https://example.com/sop.pdf' }
];
/* ================================================== */

function $(id){ return document.getElementById(id); }
function showLoading(){ $('loadingModal').classList.remove('hidden'); $('loadingModal').classList.add('flex'); }
function hideLoading(){ $('loadingModal').classList.add('hidden'); $('loadingModal').classList.remove('flex'); }

/* ===== navigation ===== */
const sections = {
  intro: $('sectionIntro'),
  form: $('sectionForm'),
  officer: $('sectionOfficer'),
  dp: $('sectionDP'),
  respond: $('sectionRespond'),
  downloads: $('sectionDownloads')
};
function setActive(tab){
  // nav buttons
  ['navIntro','navForm','navOfficer','navDP','navRespond','navDownloads'].forEach(id=> document.getElementById(id).classList.remove('active'));
  $('navIntro').classList.remove('active'); // reset
  // hide sections
  Object.values(sections).forEach(s=> s.classList.add('hidden'));
  if (tab==='intro') { $('navIntro').classList.add('active'); sections.intro.classList.remove('hidden'); }
  if (tab==='form') { $('navForm').classList.add('active'); sections.form.classList.remove('hidden'); }
  if (tab==='officer') { $('navOfficer').classList.add('active'); sections.officer.classList.remove('hidden'); loadRequests(); }
  if (tab==='dp') { $('navDP').classList.add('active'); sections.dp.classList.remove('hidden'); loadDpList(); }
  if (tab==='respond') { $('navRespond').classList.add('active'); sections.respond.classList.remove('hidden'); }
  if (tab==='downloads') { $('navDownloads').classList.add('active'); sections.downloads.classList.remove('hidden'); renderDownloads(); }
}
document.getElementById('navIntro').addEventListener('click', ()=> setActive('intro'));
document.getElementById('navForm').addEventListener('click', ()=> setActive('form'));
document.getElementById('navOfficer').addEventListener('click', ()=> setActive('officer'));
document.getElementById('navDP').addEventListener('click', ()=> setActive('dp'));
document.getElementById('navRespond').addEventListener('click', ()=> setActive('respond'));
document.getElementById('navDownloads').addEventListener('click', ()=> setActive('downloads'));

/* ===== render downloads ===== */
function renderDownloads(){
  const cont = $('downloadsList'); cont.innerHTML='';
  DOWNLOAD_LINKS.forEach(d=>{
    const btn = document.createElement('a'); btn.href = d.url; btn.target='_blank';
    btn.className='px-4 py-2 bg-gray-100 rounded inline-block';
    btn.textContent = d.label;
    cont.appendChild(btn);
  });
}

/* ===== set min date for travelStart (>= 30 days) ===== */
(function setMinTravelDate(){
  const el = $('travelStart');
  if (!el) return;
  const today = new Date();
  const minDate = new Date(today.getTime() + 30*24*60*60*1000);
  const yyyy = minDate.getFullYear();
  const mm = String(minDate.getMonth()+1).padStart(2,'0');
  const dd = String(minDate.getDate()).padStart(2,'0');
  el.min = `${yyyy}-${mm}-${dd}`;
})();

/* ===== leaders dynamic (name + phone) ===== */
let leaders = [];
function renderLeaders(){
  const container = $('leaderList'); container.innerHTML='';
  if (leaders.length===0) leaders.push({name:'', phone:''});
  leaders.forEach((obj,i)=>{
    const div = document.createElement('div'); div.className='flex gap-2 items-center';
    div.innerHTML = `
      <input class="flex-1 border p-2 rounded leaderName" placeholder="Nama Ketua ${i+1}" data-index="${i}" value="${obj.name||''}" />
      <input class="w-40 border p-2 rounded leaderPhone" placeholder="No. Tel" data-index="${i}" value="${obj.phone||''}" />
      <button type="button" data-index="${i}" class="removeLead bg-red-500 text-white px-2 rounded">X</button>
    `;
    container.appendChild(div);
  });
  container.querySelectorAll('.removeLead').forEach(btn=> btn.addEventListener('click', ev=>{ const i=parseInt(ev.target.dataset.index); leaders.splice(i,1); renderLeaders(); }));
  container.querySelectorAll('.leaderName').forEach(inp=> inp.addEventListener('input', ev=>{ const i=parseInt(ev.target.dataset.index); leaders[i].name = ev.target.value; }));
  container.querySelectorAll('.leaderPhone').forEach(inp=> inp.addEventListener('input', ev=>{ const i=parseInt(ev.target.dataset.index); leaders[i].phone = ev.target.value; }));
}
$('addLeader').addEventListener('click', ()=>{ leaders.push({name:'', phone:''}); renderLeaders(); });
renderLeaders();

/* ===== helper: file to base64 ===== */
function fileToBase64(file) {
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve({ name: file.name, type: file.type || 'application/pdf', data: r.result.split(',')[1] });
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ===== submit new permohonan ===== */
$('permohonanForm').addEventListener('submit', async function(ev){
  ev.preventDefault();
  $('submitBtn').disabled = true;
  showLoading();
  try {
    const payload = {
      schoolCode: $('schoolCode').value.trim(),
      schoolName: $('schoolName').value.trim(),
      schoolEmail: $('schoolEmail').value.trim(),
      category: $('category').value,
      travelStartDate: $('travelStart').value,
      travelEndDate: $('travelEnd').value,
      leaderNames: leaders.map(l=>l.name).filter(Boolean),
      leaderPhones: leaders.map(l=>l.phone).filter(Boolean),
      vehicleCount: $('vehicleCount').value,
      placeVisit: $('placeVisit').value,
      accommodation: $('accommodation').value,
      participantCount: $('participantCount').value
    };

    // client date validation
    const start = new Date(payload.travelStartDate);
    const today = new Date(); today.setHours(0,0,0,0);
    const min = new Date(today.getTime() + 30*24*60*60*1000);
    if (isNaN(start.getTime()) || start < min) {
      Swal.fire({ icon:'error', title:'Tarikh tidak sah', text:'Tarikh mula mesti sekurang-kurangnya 30 hari dari hari ini.'});
      $('submitBtn').disabled=false; hideLoading(); return;
    }

    // gather files
    const fileMap = {
      kertasKerja: $('file_kertasKerja').files[0],
      maklumatAnggota: $('file_maklumatAnggota').files[0],
      permitBas: $('file_permitBas').files[0],
      lesenPemandu: $('file_lesenPemandu').files[0],
      taklimat: $('file_taklimat').files[0]
    };
    const filesBase64 = {};
    for (const k in fileMap) if (fileMap[k]) filesBase64[k] = await fileToBase64(fileMap[k]);

    // send JSON body (type: 'new')
    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ type:'new', payload, filesBase64 }) });
    const j = await res.json();
    hideLoading();
    if (j.ok) {
      Swal.fire({ icon:'success', title:'Permohonan dihantar', text: 'Nombor rujukan: ' + j.requestId });
      $('permohonanForm').reset(); leaders = []; renderLeaders();
    } else {
      Swal.fire({ icon:'error', title:'Gagal', text: j.message || j.error || JSON.stringify(j) });
    }
  } catch (err) {
    hideLoading();
    Swal.fire({ icon:'error', title:'Ralat sambungan', text: err.message });
  } finally { $('submitBtn').disabled = false; }
});

/* ===== Respond to Query (Sekolah) ===== */
$('respondForm').addEventListener('submit', async function(ev){
  ev.preventDefault();
  $('respSubmitBtn').disabled = true; showLoading();
  try {
    const payload = { requestId: $('respRequestId').value.trim(), queryId: $('respQueryId').value.trim(), schoolEmail: $('schoolEmail').value.trim() || '' };
    if (!payload.requestId || !payload.queryId) { Swal.fire({icon:'error', title:'Sila isi Request & Query ID'}); $('respSubmitBtn').disabled=false; hideLoading(); return; }

    const fileMap = {
      kertasKerja: $('resp_file_kertasKerja').files[0],
      maklumatAnggota: $('resp_file_maklumatAnggota').files[0],
      permitBas: $('resp_file_permitBas').files[0],
      lesenPemandu: $('resp_file_lesenPemandu').files[0],
      taklimat: $('resp_file_taklimat').files[0]
    };
    const filesBase64 = {};
    for (const k in fileMap) if (fileMap[k]) filesBase64[k] = await fileToBase64(fileMap[k]);

    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ type:'queryResponse', payload, filesBase64 }) });
    const j = await res.json();
    hideLoading();
    if (j.ok) {
      Swal.fire({ icon:'success', title:'Berjaya', text: 'Tindak balas query telah diterima.' });
      $('respondForm').reset();
    } else Swal.fire({ icon:'error', title:'Gagal', text: j.message || JSON.stringify(j) });
  } catch (err) {
    hideLoading();
    Swal.fire({ icon:'error', title:'Ralat sambungan', text: err.message });
  } finally { $('respSubmitBtn').disabled=false; }
});

/* ===== Officer login & listRequests ===== */
let officerSecret = null;
$('loginOfficer').addEventListener('click', async ()=>{
  const pw = await Swal.fire({ title:'Masukkan kata laluan Pegawai', input:'password', inputPlaceholder:'Katalaluan Pegawai', showCancelButton:true });
  if (!pw || !pw.value) return;
  officerSecret = pw.value;
  try {
    const res = await fetch(`${GAS_URL}?action=checkSecret&secret=${encodeURIComponent(officerSecret)}`);
    const j = await res.json();
    if (j.ok) { Swal.fire({icon:'success', title:'Log masuk berjaya'}); loadRequests(); setActive('officer'); } else { officerSecret = null; Swal.fire({icon:'error', title:'Kata laluan salah'}); }
  } catch (err) { Swal.fire({icon:'error',title:'Ralat', text:err.message}); officerSecret=null; }
});

async function loadRequests(){
  if (!officerSecret) { console.warn('Need login'); return; }
  showLoading();
  try {
    const res = await fetch(`${GAS_URL}?action=listRequests&secret=${encodeURIComponent(officerSecret)}`);
    const j = await res.json(); hideLoading();
    if (!j.ok) { Swal.fire({icon:'error', title:'Gagal', text:j.message||JSON.stringify(j)}); return; }
    renderRequestsTable(j.requests);
  } catch (err) { hideLoading(); Swal.fire({icon:'error', title:'Ralat', text: err.message}); }
}

function renderRequestsTable(requests){
  const filter = $('filterCategory').value;
  const container = $('requestsTable'); container.innerHTML='';
  const table = document.createElement('table'); table.className='w-full text-sm';
  table.innerHTML = `<thead><tr class="bg-gray-100"><th class="p-2">ID</th><th>Nama Sekolah</th><th>Tarikh</th><th>Status</th><th>Tindakan</th></tr></thead>`;
  const tb = document.createElement('tbody');

  requests.forEach(req=>{
    if (filter && req['Category'] !== filter) return;
    const tr = document.createElement('tr'); tr.className='border-b';
    const travelDate = req['Travel Start'] || req['Submission Time'] || '';
    tr.innerHTML = `<td class="p-2">${req['Request ID']||''}</td>
                    <td>${req['School Name']||''}</td>
                    <td>${travelDate}</td>
                    <td>${req['Status']||''}</td>`;
    const td = document.createElement('td'); td.className='p-2 flex gap-2';

    // VIEW ALL FILES BUTTON (open all available files in new tabs)
    const viewBtn = document.createElement('button'); viewBtn.className='px-2 py-1 border rounded'; viewBtn.textContent='LIHAT FAIL';
    viewBtn.addEventListener('click', ()=>{
      const keys = ['File_KERTAS_KERJA','File_MAKLUMAT_ANGGOTA','File_PERMIT_BAS','File_LESEN_PEMANDU','File_TAKLIMAT','Letters'];
      let any=false;
      keys.forEach(k=>{
        if (req[k]) {
          any=true;
          // sometimes cell contains multiple URLs separated by ; 
          const items = req[k].toString().split(/\s*;\s*/).filter(Boolean);
          items.forEach(u=> window.open(u,'_blank'));
        }
      });
      if (!any) Swal.fire({icon:'info', title:'Tiada fail', text:'Tiada fail dilampirkan untuk permohonan ini.'});
    });

    // Query (Pegawai memerlukan input nota)
    const queryBtn = document.createElement('button'); queryBtn.className='px-2 py-1 bg-yellow-400 rounded'; queryBtn.textContent='Query';
    queryBtn.addEventListener('click', async ()=>{
      const { value: note } = await Swal.fire({ title:'Catatan (kenapa query)', input:'textarea', inputPlaceholder:'Nyatakan perkara yang dikehendaki', showCancelButton:true });
      if (!note) return;
      // call officerAction
      try {
        const r = await fetch(`${GAS_URL}?action=officerAction&id=${encodeURIComponent(req['Request ID'])}&type=query&note=${encodeURIComponent(note)}&pic=Menengah&secret=${encodeURIComponent(officerSecret)}`);
        const j = await r.json();
        if (j.ok) { Swal.fire({icon:'success', title:'Marked Query', text:'Query ID: ' + (j.queryId || '') }); loadRequests(); } else Swal.fire({icon:'error', title:'Gagal', text:j.message||JSON.stringify(j)});
      } catch (err) { Swal.fire({icon:'error', title:'Ralat', text:err.message}); }
    });

    // Preapprove -> generate letters
    const preBtn = document.createElement('button'); preBtn.className='px-2 py-1 bg-green-600 text-white rounded'; preBtn.textContent='Lulus (Jana Surat)';
    preBtn.addEventListener('click', async ()=>{
      const { value: formValues } = await Swal.fire({
        title:'Jana Surat Kelulusan',
        html:
          '<input id="swalNoJilid" class="swal2-input" placeholder="No Jilid Surat">' +
          '<input id="swalBilSurat" class="swal2-input" placeholder="Bil Surat (angka)" value="1">' +
          `<input id="swalTarikh" class="swal2-input" placeholder="Tarikh Surat (YYYY-MM-DD)" value="${new Date().toISOString().slice(0,10)}">`,
        focusConfirm:false,
        preConfirm: ()=>{
          return {
            noJilid: document.getElementById('swalNoJilid').value,
            bilSurat: document.getElementById('swalBilSurat').value,
            tarikhSurat: document.getElementById('swalTarikh').value
          };
        },
        showCancelButton:true
      });
      if (!formValues) return;
      // first mark preapprove
      try {
        const r1 = await fetch(`${GAS_URL}?action=officerAction&id=${encodeURIComponent(req['Request ID'])}&type=preapprove&note=&pic=Menengah&secret=${encodeURIComponent(officerSecret)}`);
        const j1 = await r1.json();
        if (!j1.ok) { Swal.fire({icon:'error', title:'Gagal', text:j1.message||JSON.stringify(j1)}); return; }
        // generate letters
        const q = `${GAS_URL}?action=generateLetters&id=${encodeURIComponent(req['Request ID'])}&secret=${encodeURIComponent(officerSecret)}&noJilid=${encodeURIComponent(formValues.noJilid)}&bilSurat=${encodeURIComponent(formValues.bilSurat)}&tarikhSurat=${encodeURIComponent(formValues.tarikhSurat)}`;
        const r2 = await fetch(q);
        const j2 = await r2.json();
        if (j2.ok) { Swal.fire({icon:'success', title:'Surat dijana'}); loadRequests(); } else Swal.fire({icon:'error', title:'Gagal jana surat', text:j2.message||JSON.stringify(j2)});
      } catch (err) { Swal.fire({icon:'error', title:'Ralat', text:err.message}); }
    });

    td.appendChild(viewBtn); td.appendChild(queryBtn); td.appendChild(preBtn);
    tr.appendChild(td); tb.appendChild(tr);
  });

  table.appendChild(tb); container.appendChild(table);
}

/* ===== officerAction helper (used earlier) ===== */
async function sendOfficerAction(id,type,note='',pic='Menengah'){
  if (!officerSecret) return Swal.fire({icon:'error', title:'Sila log masuk dahulu'});
  const url = `${GAS_URL}?action=officerAction&id=${encodeURIComponent(id)}&type=${encodeURIComponent(type)}&note=${encodeURIComponent(note)}&pic=${encodeURIComponent(pic)}&secret=${encodeURIComponent(officerSecret)}`;
  const r = await fetch(url); const j = await r.json();
  return j;
}

/* ===== DP login & list for DP ===== */
let dpSecret = null;
$('loginDP').addEventListener('click', async ()=>{
  const pw = await Swal.fire({ title:'Masukkan kata laluan Timbalan', input:'password', inputPlaceholder:'Katalaluan Timbalan', showCancelButton:true });
  if (!pw || !pw.value) return;
  dpSecret = pw.value;
  try {
    const res = await fetch(`${GAS_URL}?action=checkSecret&secret=${encodeURIComponent(dpSecret)}`);
    const j = await res.json();
    if (j.ok) { Swal.fire({icon:'success', title:'Log masuk Timbalan berjaya'}); loadDpList(); setActive('dp'); } else { dpSecret=null; Swal.fire({icon:'error', title:'Kata laluan salah'}); }
  } catch (err) { dpSecret=null; Swal.fire({icon:'error', title:'Ralat', text:err.message}); }
});

async function loadDpList(){
  if (!dpSecret) return;
  showLoading();
  try {
    const res = await fetch(`${GAS_URL}?action=listRequests&secret=${encodeURIComponent(dpSecret)}`);
    const j = await res.json(); hideLoading();
    if (!j.ok) { Swal.fire({icon:'error', title:'Gagal', text:j.message||JSON.stringify(j)}); return; }
    renderDpList(j.requests);
  } catch (err) { hideLoading(); Swal.fire({icon:'error', title:'Ralat', text:err.message}); }
}

function renderDpList(requests){
  const rows = requests.filter(r=> r['Status'] && (r['Status'].toString().indexOf('READY_FOR_DP')>-1 || r['Status']==='PREAPPROVED' || r['Status']==='QUERY_RESPONDED'));
  const container = $('dpRequestsTable'); container.innerHTML='';
  rows.forEach(req=>{
    const card = document.createElement('div'); card.className='border p-3 mb-2 rounded';
    card.innerHTML = `<div class="font-semibold">${req['Request ID']} ‚Äî ${req['School Name']}</div><div class="text-sm">Status: ${req['Status']||''}</div>`;
    const btn = document.createElement('button'); btn.className='mt-2 px-3 py-1 bg-green-600 text-white rounded'; btn.textContent='Diluluskan (Hantar Surat)';
    btn.addEventListener('click', async ()=>{
      if (!confirm('Sahkan hantar surat kelulusan kepada sekolah?')) return;
      try {
        const r2 = await fetch(`${GAS_URL}?action=finalApprove&id=${encodeURIComponent(req['Request ID'])}&secret=${encodeURIComponent(dpSecret)}`);
        const j2 = await r2.json();
        if (j2.ok) { Swal.fire({icon:'success', title:'Emel dihantar'}); loadDpList(); } else Swal.fire({icon:'error', title:'Gagal', text:j2.message||JSON.stringify(j2)});
      } catch (err) { Swal.fire({icon:'error', title:'Ralat', text:err.message}); }
    });
    card.appendChild(btn); container.appendChild(card);
  });
}

/* ===== initial state ===== */
setActive('intro');

</script>
</body>
</html>
